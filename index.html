<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <title>Fermi LAT Light Curve Repository</title>

    <script type="text/javascript" charset="UTF-8" src="./js/d3.min.js"></script>
    <script type="text/javascript" charset="UTF-8" src="./js/d3.geo.projection.min.js"></script>
    <!-- <script type="text/javascript" src="./js/celestial.min.js"></script> -->
    <script type="text/javascript" charset="UTF-8" src="./js/celestial.js"></script>
    <script type="text/javascript" charset="UTF-8" src="./js/astro.js"></script>
    <!-- <script language="javascript" type="text/javascript" src="./js/astro.dates.js"></script> -->
    <script type="text/javascript" charset="UTF-8" src="./js/astro.coords.js"></script>
    <script type="text/javascript" charset="UTF-8" src="./js/ephemeris.js"></script>

    <!-- jQuery -->
    <script type="text/javascript" charset="UTF-8" src="./js/jquery-1.12.0.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> -->

    <!-- Chart.js -->
    <script type="text/javascript" charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

    <!-- Bootstrap compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- Bootstrap compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Bootstrap Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Reset css -->
    <link rel="stylesheet" hrmouseef="./css/reset.css" type="text/css" />

    <!-- NASA theme -->
    <link rel="stylesheet" href="./css/NASA.css">

    <!-- Celestial.js theme -->
    <link rel="stylesheet" href="./css/celestial.css">

    <!-- Highcharts CDN -->
    <!-- <script src="https://code.highcharts.com/highcharts.src.js"></script> -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>

    <!--Plugin CSS file with desired skin-->
    <!-- <link rel="stylesheet" href="./css/ion.rangeSlider.css"/> -->
    <link rel="stylesheet" href="./css/ion.rangeSliderNX.css"/>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/> -->

    <!--Plugin JavaScript file-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
  
    <!-- Moment.js -->
    <script charset="UTF-8" src="./js/moment.js"></script>

</head>


<!-- custom css -->
<style type="text/css">

    #celestial-map {
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently supported by Chrome, Opera and Firefox */ 
        overflow-x: hidden;
        overflow-y: hidden;

    }

    /* The red selection circle */
    #selection {
        border: solid;
        border-radius: 15px;
        border-width: 1px;
        /*border-color: red;*/
        border-color: rgba(57, 66, 100, .80);
        background-color: rgba(57, 66, 100, .80);
        opacity: 0.25;
        position: absolute;
        height: 15px;
        width: 15px;    
        top: 100px;
        visibility: hidden;
        overflow: hidden;
        overflow-x: hidden;
        overflow-y: hidden;
        pointer-events: none;
    }

    /* The selection tool tip */
    #tooltip_map {
        border: solid;
        border-radius: 5px;
        background-color: rgba(240,240,240,.95);
        border: 2px solid rgba(0, 0, 0, .9);
        position: absolute;
        width: auto;
        height: auto;               
        top: 100px;
        box-shadow: 0 1px 2px rgba(0,0,0,.4), 0 1px 0 rgba(255,255,255,.5) inset;
        text-align: left;
        color: #000;
        padding: 10px 10px 10px 10px;
        font-size: 14px;
        line-height: 125%;
        visibility: hidden;
        overflow-x: hidden;
        overflow-y: hidden;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;  
      
    }

    .row-small-gutter>* {
        padding-left: 4px;
        padding-right: 4px;
    }

    .row-small-gutter-2>* {
        padding: 0px 2px 0px 2px;
    }

    .input-group-addon {
        min-width:85px;
        text-align:left;
    }

    text {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;  
    }


    hr {
      margin-top: 1rem;
      margin-bottom: 1rem;
      margin-left:10px;
      margin-right:10px;
      border: 0;
      border-top: 1px solid rgba(0, 0, 0, 0.2);
    }

    .custom-header {
        margin: 0px 0px 0px 10px;
        margin-left:10px;
    }

    #data_table {
        background-image:"./img/loading_apple.gif";}
    }

    .material-switch > input[type="checkbox"] {
        display: none;   
    }

    .material-switch > label {
        cursor: pointer;
        height: 0px;
        position: relative; 
        width: 40px;  
    }

    .material-switch > label::before {
        background: rgb(0, 0, 0);
        box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        content: '';
        height: 16px;
        margin-top: -8px;
        position:absolute;
        opacity: 0.3;
        transition: all 0.4s ease-in-out;
        width: 40px;
    }
    .material-switch > label::after {
        background: rgb(255, 255, 255);
        border-radius: 16px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        content: '';
        height: 24px;
        left: -4px;
        margin-top: -8px;
        position: absolute;
        top: -4px;
        transition: all 0.3s ease-in-out;
        width: 24px;
    }
    .material-switch > input[type]:checked + label::before {
        background: inherit;
        opacity: 0.5;
    }
    .material-switch > input[type="checkbox"]:checked + label::after {
        background: inherit;
        left: 20px;
    }

    /* The switch - the box around the slider */
    .switch {
      position: relative;
      display: inline-block;
      width: 45px;
      height: 26px;
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .slider.primary {
      background-color: #2c6c9f;
    }

    /*input:focus + .slider.primary {
      box-shadow: 0 0 1px #2196F3;
    }
    */

    input:checked + .slider.green {
      /*background-color: #5fb35f;*/
      background-color: rgb(57,142,68, 1);
    }

    input:checked + .slider.orange {
      /*background-color: #f8a139;*/
        background-color: rgb(215,120,18, 1)
    }

    input:checked + .slider.red {
      background-color: #d74b49;
    }

    input:checked + .slider.blue {
      background-color: #48aec9;
    }


    input:checked + .slider:before {
      -webkit-transform: translateX(19px);
      -ms-transform: translateX(19px);
      transform: translateX(19px);
    }

    /* Rounded sliders */
    .slider.round {
      border-radius: 17px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    #timeline {
        display: none;
    }


    .hidden {
       position: absolute !important;
       top: -9999px !important;
       left: -9999px !important;
    }


/*    .timeline.label {
        font-weight: normal !important;
    }  */ 

</style>


<body>

  <script type="text/javascript" charset="UTF-8">

        var canvas;
        var selection;
        var tooltip_map;
        var scale_initial;
        var json_reticale;
        var showReticale;
        var search_coordinates;
        var data_FGL;
        var data_FGL_unsorted;
        var URL
        var classifications;
        var occurrences;
        var colors;
        var search_ra;
        var search_dec;
        var pointStyle;
        var labelStyle;
        var data_FGL_original;
        var date_to;
        var date_from;
        var previousRowElement;
        var previousRowBackgroundColor;
        var MET_start;
        var MET_stop;
        var sun_coordinates;
        var MET_current;
        var MJD_current;
        var date_string_current;
        var data_2FAV_subset;
        var magicWord;
        var passphrase;

        var search_radius = 0;
        var search_keyword = ''
        var radians2degrees = 57.2958 
        var deg2rad = 2*Math.PI/360.
        var isMouseDown = false;
        var isMapAnimating = false;
        var palette = ['#0d47a1','#007E33', '#FF8800','#CC0000','#9933CC','#0d47a1','#00C851','#ffbb33','#ff4444','#aa66cc','#00695c','#2BBBAD','#3F729B']
        var shouldDisplayDistance = false;
        var perform_search = false;
        var catalog = '3FGL';
        var show_FGL = true;
        var show_2FAV = false;
        var show_2FLGC = false;
        var show_IceCube = false;
        var show_tooltip = true;
        var always_show_errors = false;
        var marker_size_varindex = true;
        var show_only_variable_4FGL_sources = true;
        var insideToolTip = true
        var startingTableRow = 0
        var maxNumberOfTableRows = 100;
        var currentTablePage = 1
        var paginations = {}
        var tableRowSelectors = {}
        var row_selector_has_changed = false;
        var showSun = true
        var showMoon = false

        var months = {'1':'Jan', '2':'Feb', '3':'Mar', '4':'Apr', '5':'May', '6':'Jun', '7':'Jul', '8':'Aug', '9':'Sep', '10':'Oct', '11':'Nov', '12':'Dec'}
        // var months = {'1':'January', '2':'Feburary', '3':'March', '4':'April', '5':'May', '6':'June', '7':'July', '8':'August', '9':'September', '10':'October', '11':'November', '12':'December'}
        var angles = [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,260,265,270,275,280,285,290,295,300,305,310,315,320,325,330,335,340,345,350,355]

        // D3-Celestial sky map. Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE 
        var config = {
            width: 0,     // Default width, 0 = full parent width; height is determined by projection
            projection: "aitoff",  // Map projection used: airy, aitoff, armadillo, august, azimuthalEqualArea, azimuthalEquidistant, baker, berghaus, boggs, bonne, bromley, collignon, craig, craster, cylindricalEqualArea, cylindricalStereographic, eckert1, eckert2, eckert3, eckert4, eckert5, eckert6, eisenlohr, equirectangular, fahey, foucaut, ginzburg4, ginzburg5, ginzburg6, ginzburg8, ginzburg9, gringorten, hammer, hatano, healpix, hill, homolosine, kavrayskiy7, lagrange, larrivee, laskowski, loximuthal, mercator, miller, mollweide, mtFlatPolarParabolic, mtFlatPolarQuartic, mtFlatPolarSinusoidal, naturalEarth, nellHammer, orthographic, patterson, polyconic, rectangularPolyconic, robinson, sinusoidal, stereographic, times, twoPointEquidistant, vanDerGrinten, vanDerGrinten2, vanDerGrinten3, vanDerGrinten4, wagner4, wagner6, wagner7, wiechel, winkel3
            transform: "galactic", // Coordinate transformation: equatorial (default), ecliptic, galactic, supergalactic
            center: [0,0],       // Initial center coordinates in equatorial transformation [hours, degrees, degrees],
                              // otherwise [degrees, degrees, degrees], 3rd parameter is orientation, null = default center
            zoomlevel: 1,
            zoomextend: 40,
            orientationfixed: true,  // Keep orientation angle the same as center[2]
            background: { fill: "#ffffff", stroke: "#000000", opacity: 1 }, // Background style
            // background: { fill: "cornflowerblue", stroke: "#ffffff", opacity: 0.5 }, // Background style
            adaptable: true,    // Sizes are increased with higher zoom-levels
            interactive: true,  // Enable zooming and rotation with mousewheel and dragging
            form: false,        // Display settings form
            location: false,    // Display location settings
            controls: true,     // Display zoom controls
            lang: "",           // Language for names, so far only for constellations: de: german, es: spanish
                              // Default:en or empty string for english
            container: "celestial-map",   // ID of parent element, e.g. div
            datapath: "./data/",  // Path/URL to data files, empty = subfolder 'data'
            stars: {
                show: false,    // Show stars
                limit: 6,      // Show only stars brighter than limit magnitude
                color: "#000000",
                colors: false,
                // colors: "#ffffff",  // Show stars in spectral colors, if not use "color"
                style: { fill: "#000000", opacity: 1 }, // Default style for stars
                names: true,   // Show star names (Bayer, Flamsteed, Variable star, Gliese, whichever applies first)
                proper: true, // Show proper name (if present)
                desig: false,  // Show all names, including Draper and Hipparcos
                namelimit: -99,  // Show only names for stars brighter than namelimit
                // namestyle: { fill: "#ddddbb", font: "11px Georgia, Times, 'Times Roman', serif", align: "left", baseline: "top" },
                // propernamestyle: { fill: "#ddddbb", font: "11px Georgia, Times, 'Times Roman', serif", align: "right", baseline: "bottom" },
                namestyle: { fill: "#000000", font: "14px Helvetica, Arial, 'Helvetica Neue', sans-serif", align: "left", baseline: "top" },
                propernamestyle: { fill: "#000000", font: "14px Helvetica, Arial, 'Helvetica Neue', sans-serif", align: "right", baseline: "bottom" },   
                propernamelimit: -99,  // Show proper names for stars brighter than propernamelimit
                size: 7,       // Maximum size (radius) of star circle in pixels
                exponent: -2, // Scale exponent for star size, larger = more linear
                data: 'stars.6.json' // Data source for stellar data
                //data: 'stars.8.json' // Alternative deeper data source for stellar data
            },
            dsos: {
                show: false,    // Show Deep Space Objects
                limit: 6,      // Show only DSOs brighter than limit magnitude
                names: true,   // Show DSO names
                desig: true,   // Show short DSO names
                namelimit: 4,  // Show only names for DSOs brighter than namelimit
                color: "#000000",
                colors: false,
                namestyle: { fill: "#000000", font: "14px Helvetica, Arial, serif", align: "left", baseline: "top" },
                size: null,    // Optional seperate scale size for DSOs, null = stars.size
                exponent: 1.4, // Scale exponent for DSO size, larger = more non-linear
                data: 'dsos.bright.json',  // Data source for DSOs
                //data: 'dsos.6.json'  // Alternative broader data source for DSOs
                //data: 'dsos.14.json' // Alternative deeper data source for DSOs
                symbols: {  //DSO symbol styles
                    gg: {shape: "circle", fill: "#000000"},                                 // Galaxy cluster
                    g:  {shape: "ellipse", fill: "#000000"},                                // Generic galaxy
                    s:  {shape: "ellipse", fill: "#000000"},                                // Spiral galaxy
                    s0: {shape: "ellipse", fill: "#000000"},                                // Lenticular galaxy
                    sd: {shape: "ellipse", fill: "#000000"},                                // Dwarf galaxy
                    e:  {shape: "ellipse", fill: "#000000"},                                // Elliptical galaxy
                    i:  {shape: "ellipse", fill: "#000000"},                                // Irregular galaxy
                    oc: {shape: "circle", fill: "#000000", stroke: "#000000", width: 1.5},  // Open cluster
                    gc: {shape: "circle", fill: "#000000"},                                 // Globular cluster
                    en: {shape: "square", fill: "#000000"},                                 // Emission nebula
                    bn: {shape: "square", fill: "#000000", stroke: "#000000", width: 2},    // Generic bright nebula
                    sfr:{shape: "square", fill: "#000000", stroke: "#000000", width: 2},    // Star forming region
                    rn: {shape: "square", fill: "#000000"},                                 // Reflection nebula
                    pn: {shape: "diamond", fill: "#000000"},                                // Planetary nebula
                    snr:{shape: "diamond", fill: "#000000"},                                // Supernova remnant
                    dn: {shape: "square", fill: "#000000", stroke: "#000000", width: 2},    // Dark nebula grey
                    pos:{shape: "marker", fill: "#000000", stroke: "#000000", width: 1.5}   // Generic marker
                }
            },
            constellations: {
                show: false,    // Show constellations
                names: true,   // Show constellation names
                desig: true,   // Show short constellation names (3 letter designations)
                namestyle: { fill:"#39645b", align: "center", baseline: "middle", opacity:0.8,
                             font: ["bold 14px Helvetica, Arial, sans-serif",  // Different fonts for brighter &
                                    "bold 12px Helvetica, Arial, sans-serif",  // sdarker constellations
                                    "bold 11px Helvetica, Arial, sans-serif"]},
                lines: true,   // Show constellation lines
                linestyle: { stroke: "#cc6666", width: 1, opacity: 0.6 }, // purple: #9966cc
                bounds: false,  // Show constellation boundaries
                boundstyle: { stroke: "#643942", width: 0.5, opacity: 0.8, dash: [2, 4] }
            },
            mw: {
                show: false,    // Show Milky Way as filled polygons
                style: { fill: "#000000", opacity: "0.15" }
            },
            lines: {
                // graticule: { show: true, stroke: "#cccccc", width: 0.6, opacity: 0.8,      // Show graticule lines
                graticule: { show: true, stroke: "#C0C0C0", width: 1, opacity: 1,      // Show graticule lines
                  // grid values: "outline", "center", or [lat,...] specific position
                  lon: {pos: ["center"], fill: "darkgray", font:  "14px Helvetica, Arial, 'Helvetica Neue', sans-serif"},
                  // grid values: "outline", "center", or [lon,...] specific position
                  lat: {pos: ["180"], fill: "darkgray", font:  "14px Helvetica, Arial, 'Helvetica Neue', sans-serif"}},
                equatorial: { show: true, stroke: "#66cccc", width: 1.3, opacity: 0.7 },    // Show equatorial plane
                ecliptic: { show: true, stroke: "#66cc66", width: 1.3, opacity: 0.7 },      // Show ecliptic plane
                galactic: { show: true, stroke: "#cc6666", width: 1.3, opacity: 0.7 },     // Show galactic plane
                supergalactic: { show: false, stroke: "#cc66cc", width: 1.3, opacity: 0.7 } // Show supergalactic plane
            }
        };


        var lineStyle = {
            stroke:"#000000",
            fill: "rgba(255, 204, 204, 0.4)",
            width: 3
        }

        var pointStyle_active = {
            stroke: "rgba(57, 66, 100, .80)",
            fill: "rgba(57, 66, 100, .80)"
            // stroke: "green",
            // fill: "green"
        };

        var pointStyle_gray = {
            stroke: "rgba(128, 128, 128, .5)",
            fill: "rgba(128, 128, 128, .5)"
            // stroke: "green",
            // fill: "green"
        };

        var pointStyle_hidden = {
            stroke: "rgba(128, 128, 128, .1)",
            fill: "rgba(128, 128, 128, .1)"
            // stroke: "green",
            // fill: "green"
        };

        var reticaleCenterStyle = {
            stroke: "darkred",
            // stroke: "rgba(139, 0, 0, 0.6)",
            width: 0.6, 
            opacity: 0.9,
        };

        var reticaleCircleStyle = {
            stroke: "darkred",
            // fill: "darkred",
            width: 0.8, 
            opacity: 0.8,
        };

        var reticaleCircleStyleThin = {
            stroke: "darkred",
            // fill: "darkred",
            width: 0.2, 
            opacity: 0.8,
        };

        var style_2FAV = {
            stroke: "#d74b49",
            fill: "#d74b49",
            width: 0.8, 
            opacity: 0.8,
        };

        var style_2FAV_circles = {
            stroke: "rgb(215,75,73, 1)",
            fill: "rgb(215,75,73, 0.75)",
            // width: 0.5, 
            // opacity: 0.6,
        };

        var style_2FAV_errors = {
            stroke: "rgb(215,75,73, 0.5)",
            fill: "rgb(215,75,73, 0.75)"
            // width: 0.8, 
            // opacity: 0.6,
        };

        var style_2FLGC = {
            stroke: "rgb(57,142,68, 1)",
            fill: "rgb(57,142,68, 0.75)"
        };        


        var style_2FLGC_error = {
            stroke: "rgb(57,142,68, 0.75)",
            fill: "rgb(57,142,68, 0.75)"
        };    

        var style_IceCube = {
            stroke: "rgb(215,120,18, 1)",
            fill: "rgb(215,120,18, 0.75)"
        };

        var style_IceCube_error = {
            stroke: "rgb(215,120,18, 0.75)",
            fill: "rgb(215,120,18, 0.75)"
        };

        var textStyle = {
            fill:"red",
            font: "normal 14px Helvetica, Arial, sans-serif",
            align: "left",
            baseline: "bottom"
        };

        var labelStyle_active = {
            fill:"black",
            font: "normal 14px Helvetica, Arial, sans-serif",
            align: "left",
            baseline: "bottom"
        };

        var labelStyle_gray = {
            fill:"rgba(128, 128, 128, .5)",
            font: "normal 14px Helvetica, Arial, sans-serif",
            align: "left",
            baseline: "bottom"
        };

        var labelStyle_hidden = {
            fill:"rgba(128, 128, 128, .1)",
            font: "normal 14px Helvetica, Arial, sans-serif",
            align: "left",
            baseline: "bottom"
        };

        var sunStyle = {
            stroke: "rgba(230, 172, 0, 1)",
            fill: "rgba(230, 172, 0, 0.8)"
            // stroke: "green",
            // fill: "green"
        };

        var moonStyle = {
            stroke: "rgba(128, 128, 128, 1)",
            fill: "rgba(128, 128, 128, 0.8)"
            // stroke: "green",
            // fill: "green"
        };

        // Define some global variables
        var PROXIMITY_LIMIT = 1700;
        var points

        // Set cookie data
        function setCookieData(name, value, expiration_days) {
            var date = new Date();
            date.setTime(date.getTime() + (expiration_days*24*60*60*1000));
            var expires = "expires="+ date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        // Get the cookie data. Return the value if found, return empty string if not
        function getCookieData(name) {
            var name_mod = name + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name_mod) == 0) {
                    return c.substring(name_mod.length, c.length);
                }
            }
            return null;
        }
        
        // Simple linear distance function
        function distance(p1, p2) {
          var d1 = p2[0] - p1[0],
              d2 = p2[1] - p1[1];
          return Math.sqrt(d1 * d1 + d2 * d2);
        }

        // Convert radians to degrees
        function rad2deg (rad) { 
            var sign2 = "";
            if ( rad < 0.0 ) { sign2 = "-"; rad = 0.0 - rad; }

            var hh = rad * toDegrees;
            hh = hh + 0.00005; // rounding
            var h = Math.floor(hh);
            hh = hh - h; // fraction
            hh = hh * 10;
            var f1 = Math.floor (hh); // Crude but easy way to get leading zeroes in fraction
            hh = hh - f1;
            hh = hh * 10;
            var f2 = Math.floor (hh); 
            hh = hh - f2;
            hh = hh * 10;
            var f3 = Math.floor (hh);
            hh = hh - f3;
            hh = hh * 10;
            var f4 = Math.floor (hh); 
            ret = sign2 + h + "." +f1+f2+f3+f4;
            return ret;
        }
        // Convert RA and Dec to galactic coordinates
        function calculateGalacticCoordinates(ra, dec) {

            // Adopted from http://www.robertmartinayers.org/tools/coordinates.html
            // Copyright Robert Martin Ayers, 2009, 2011, 2014.  All rights reserved.

            // Define some constants            
            pi = 3.1415926536
            toDegrees = 180.0/pi;
            degrees2arcseconds = 3600.;
            hours2degrees = 360/24.

            // From J2000 to "galactic coordinates"
            // Spherical Astronomy by Green, equation 14.55, page 355
            var JtoG = new Array (
            -0.054876, -0.873437, -0.483835,
             0.494109, -0.444830,  0.746982,
            -0.867666, -0.198076,  0.455984 );

            var radec = new Array (99.0, 99.0);

            // Converting the user supplied ra and dec from degrees to arcseconds
            globalJRA = parseFloat(ra) * degrees2arcseconds;
            globalJDec = parseFloat(dec) * degrees2arcseconds;

            var radec1 = new Array ( (globalJRA/3600.0) / toDegrees, 
            (globalJDec/3600.0) / toDegrees );

            radec = radec1;
            matrix = JtoG;

            var r0 = new Array ( 
            Math.cos(radec[0]) * Math.cos(radec[1]),
            Math.sin(radec[0]) * Math.cos(radec[1]),
            Math.sin(radec[1]) );

            var s0 = new Array (
            r0[0]*matrix[0] + r0[1]*matrix[1] + r0[2]*matrix[2], 
            r0[0]*matrix[3] + r0[1]*matrix[4] + r0[2]*matrix[5], 
            r0[0]*matrix[6] + r0[1]*matrix[7] + r0[2]*matrix[8] ); 

            var r = Math.sqrt ( s0[0]*s0[0] + s0[1]*s0[1] + s0[2]*s0[2] ); 

            var result = new Array ( 0.0, 0.0 );
            result[1] = Math.asin ( s0[2]/r ); // New dec in range -90.0 -- +90.0 
            // or use sin^2 + cos^2 = 1.0  
            var cosaa = ( (s0[0]/r) / Math.cos(result[1] ) );
            var sinaa = ( (s0[1]/r) / Math.cos(result[1] ) );
            result[0] = Math.atan2 (sinaa,cosaa);

            if ( result[0] < 0.0 ) {
                result[0] = result[0] + pi + pi;
            }

            gall = parseFloat(rad2deg(result[0]));
            galb = parseFloat(rad2deg(result[1]));

            return [gall, galb]
        }

        function angularDistance(lat1, lon1, lat2, lon2) {

            const φ1 = lat1 * Math.PI/180; // φ, λ in radians
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            const d = c * 57.2958; // in degrees

            return d
        }

        function hms2decimaldegrees(hms) {

            degrees = (hms / 24.0) * 360.
        }


        function calculateSunPosition(dateObj) {

            var observers_longitude = 139.74;
            var observers_latitude = 35.65;

            var ephem = new Ephemeris();
            var jd = ephem.JulianDay(dateObj);

            var sun = ephem.Sun(dateObj);
            var sun_longitude = sun.longitude;
            var sun_distance = sun.distance;
            var sun_ra = sun.ra;
            var sun_dec = sun.dec;
            var sun_eci = ephem.to_eci(sun_ra,sun_dec,sun_distance);
            var sun_horizontal = ephem.to_horizontal(dateObj,observers_longitude,observers_latitude,sun_ra,sun_dec);

            // return both ra and dec in decimal degrees
            sun_ra = (sun_ra / 24.0) * 360.

            return [sun_ra, sun_dec]
        }

        function calculateMoonPosition(dateObj) {

            var observers_longitude = 139.74;
            var observers_latitude = 35.65;

            var ephem = new Ephemeris();
            var moon = ephem.Moon(dateObj);
            var moon_longitude = moon.longitude;
            var moon_latitude = moon.latitude;
            var moon_distance = moon.distance;
            var moon_ra = moon.ra;
            var moon_dec = moon.dec;
            var moon_eci = ephem.to_eci(moon_ra,moon_dec,moon_distance);
            var moon_horizontal = ephem.to_horizontal(dateObj,observers_longitude,observers_latitude,moon_ra,moon_dec);

            // return both ra and dec in decimal degrees
            moon_ra = (moon_ra / 24.0) * 360.

            return [moon_ra, moon_dec]
        }

        function sourceIncludesKeyword(sourceRecord, search_keyword) {

            // Check to see if the search keyword exists in any of the string value, otherwise skip this row
            try {
                if (search_keyword.length > 0) {
                    if (sourceRecord['Source_Name'].toLowerCase().includes(search_keyword) || sourceRecord['CLASS1'].toLowerCase().includes(search_keyword) || sourceRecord['ASSOC1'].toLowerCase().includes(search_keyword) || sourceRecord['SpectrumType'].toLowerCase().includes(search_keyword)) {
                        return true;
                    } else {
                        return false
                    }
                } 

            } catch(error) {
                // Do nothing for now
            }

        }        

        function redraw() {
            
            var m = Celestial.metrics(), // Get the current map size in pixels

            // empty quadtree, will be used for proximity check
            quadtree = d3.geom.quadtree().extent([[-1, -1], [m.width + 1, m. height + 1]])([]);

            map_width = m.width;
            map_height = m.height;

            // Save all the points currently on the canvas
            points = [];

            // Display the 3FGL data
            if (typeof data_FGL !== 'undefined' && show_FGL === true) {

                for (i=0; i<data_FGL.length; i++) {

                    var coordinates
                    var source = data_FGL[i]

                    if (config.transform.includes('equatorial')) {
                        coordinates = [source.RAJ2000, source.DEJ2000]
                    } else if (config.transform.includes('galactic')) {
                        coordinates = [source.GLON, source.GLAT]
                    }

                    // If point is visible (this doesn't work automatically for points)
                    if (Celestial.clip(coordinates)) {

                        var point = Celestial.mapProjection(coordinates);

                        if (point[0] >= 0 && point[0] <= map_width && point[1] >= 0 && point[1] <= map_height) { 

                            // Determine what color this source should be
                            if (perform_search === true) {

                                // Position search only
                                if (search_keyword.length === 0) {
                                    if (source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                                // Keyword search only
                                if (search_radius === 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_hidden
                                        labelStyle = labelStyle_hidden
                                        source['active'] = false
                                    }
                                }

                                // Position and keyword search
                                if (search_keyword.length > 0 && search_radius > 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true && source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else { 
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                            } else {
                                pointStyle = pointStyle_active
                                labelStyle = labelStyle_active
                                source['active'] = true
                            }

                            if ((show_only_variable_4FGL_sources === true) && (perform_search == false)) {
                                if (parseFloat(source.Variability_Index) < 18) {
                                    pointStyle = {stroke: "rgba(128, 128, 128, .25)", fill: "rgba(128, 128, 128, .25)" };
                                } else {
                                    pointStyle = pointStyle_active
                                }
                            }

                            source['catalog'] = 'FGL'
                            source['xCanvas'] = point[0]
                            source['yCanvas'] = point[1]

                            // Add the point to the list of points on the canvas
                            points.push(source)

                            // object radius in pixel, could be varable depending on e.g. magnitude
                            // var r = Math.pow(parseInt(source.Signif_Avg) * 0.2, 0.3);
                            if ($("#marker_size_varindex")[0].checked === true) {
                                var r = Math.pow(parseInt(source.Variability_Index) * 1, 0.225)/1.5;
                            } else {
                                // var r = Math.pow(parseInt(source.Signif_Avg) * 1, 0.25)/1.25;
                                var r = Math.pow(parseInt(source.Signif_Avg) * 0.2, 0.4);

                            }


                            // draw on canvas
                            Celestial.setStyle(pointStyle);
                            Celestial.context.beginPath();
                            Celestial.context.arc(point[0], point[1], r, 0, 2 * Math.PI);
                            Celestial.context.closePath();
                            Celestial.context.stroke();
                            Celestial.context.fill();
                        }

                        if (Celestial.zoomBy() >= 16.0) {
                            Celestial.setTextStyle(labelStyle);
                            Celestial.context.fillText(source.Source_Name, point[0] + r + 7.5, point[1] + r - 7.5);

                        } 

                    }      

                }             
            }

            if (typeof data_2FAV !== 'undefined' && show_2FAV === true) {

                for (i=0; i<data_2FAV.length; i++) {

                    var coordinates
                    var source = data_2FAV[i]

                    // Skip this source if it's outside the temporal search window
                    if ((parseFloat(source.tmin) < MET_start) || (parseFloat(source.tmax)) > MET_stop) {
                        continue
                    }

                    if (config.transform.includes('equatorial')) {
                        coordinates = [source.fava_ra, source.fava_dec]
                    } else if (config.transform.includes('galactic')) {
                        coordinates = [source.gall, source.galb]
                    }

                    // If point is visible (this doesn't work automatically for points)
                    if (Celestial.clip(coordinates)) {

                        var point = Celestial.mapProjection(coordinates);

                        if (point[0] >= 0 && point[0] <= map_width && point[1] >= 0 && point[1] <= map_height) { 

                            // Determine what color this source should be
                            if (perform_search === true) {

                                // Position search only
                                if (search_keyword.length === 0) {
                                    if (source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                                // Keyword search only
                                if (search_radius === 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_hidden
                                        labelStyle = labelStyle_hidden
                                        source['active'] = false
                                    }
                                }

                                // Position and keyword search
                                if (search_keyword.length > 0 && search_radius > 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true && source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else { 
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                            } else {
                                pointStyle = pointStyle_active
                                labelStyle = labelStyle_active
                                source['active'] = true
                            }


                            source['catalog'] = '2FAV'
                            source['xCanvas'] = point[0]
                            source['yCanvas'] = point[1]

                            // Add the point to the list of points on the canvas
                            points.push(source)

                            // object radius in pixel, could be varable depending on e.g. magnitude
                            // var r = Math.pow(parseInt(source.sigma*2) * 0.5, 0.3);
                            var r = Math.pow(parseInt(source.sigma) * 0.4, 0.5);

                            // draw on canvas
                            Celestial.setStyle(style_2FAV);
                            Celestial.context.beginPath();
                            Celestial.context.font = "11px Arial";
                            Celestial.context.fillText('+', point[0], point[1]+5);
                            Celestial.context.closePath();
                            Celestial.context.stroke();
                            Celestial.context.fill();

                            // draw on canvas
                            // Celestial.setStyle(style_2FAV_circles);
                            // Celestial.context.beginPath();
                            // // Celestial.context.arc(point[0], point[1], r/2.0, 0, 2 * Math.PI);
                            // Celestial.context.arc(point[0], point[1], r, 0, 2 * Math.PI);
                            // Celestial.context.closePath();
                            // Celestial.context.stroke();
                            // Celestial.context.fill();

                        }

                        if (Celestial.zoomBy() >= 16.0) {

                        //     Celestial.setTextStyle(labelStyle);
                        //     Celestial.context.fillText(source.flareID, point[0] + r + 7.5, point[1] + r - 7.5);

                            // // draw on canvas
                            // Celestial.setStyle(style_2FAV);
                            // Celestial.context.beginPath();
                            // Celestial.context.setLineDash([5, 5])
                            // Celestial.context.arc(point[0], point[1], 50, 0, 2 * Math.PI);
                            // Celestial.context.closePath();
                            // Celestial.context.stroke();
                            // // Celestial.context.fill();

                            var radius_canvas;
                                var test_point1 = Celestial.mapProjection([coordinates[0], coordinates[1]]);
                                var test_point2 = Celestial.mapProjection([coordinates[0], coordinates[1]-(parseFloat(source.best_r95))]);
                                var dx = test_point1[0] - test_point2[0];
                                var dy = test_point1[1] - test_point2[1];
                                radius_canvas = Math.sqrt( dx*dx + dy*dy );
                            
                            // draw on canvas
                            Celestial.setStyle(style_2FAV_errors);
                            Celestial.context.beginPath();
                            Celestial.context.setLineDash([5, 5])
                            Celestial.context.arc(point[0], point[1], radius_canvas, 0, 2 * Math.PI);
                            Celestial.context.closePath();
                            Celestial.context.stroke();


                        } 
                    }      
                }
            }

            if (typeof data_2FLGC !== 'undefined' && show_2FLGC === true) {

                for (i=0; i<data_2FLGC.length; i++) {

                    var coordinates
                    var source = data_2FLGC[i]

                    // Skip this source if it's outside the temporal search window
                    if ((parseFloat(source.GRBMET) < MET_start) || (parseFloat(source.GRBMET)) > MET_stop) {
                        continue
                    }

                    if (config.transform.includes('equatorial')) {
                        coordinates = [source.RA, source.DEC]
                    } else if (config.transform.includes('galactic')) {
                        coordinates = calculateGalacticCoordinates(source.RA, source.DEC)
                    }

                    // If point is visible (this doesn't work automatically for points)
                    if (Celestial.clip(coordinates)) {

                        var point = Celestial.mapProjection(coordinates);

                        if (point[0] >= 0 && point[0] <= map_width && point[1] >= 0 && point[1] <= map_height) { 

                            // Determine what color this source should be
                            if (perform_search === true) {

                                // Position search only
                                if (search_keyword.length === 0) {
                                    if (source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                                // Keyword search only
                                if (search_radius === 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_hidden
                                        labelStyle = labelStyle_hidden
                                        source['active'] = false
                                    }
                                }

                                // Position and keyword search
                                if (search_keyword.length > 0 && search_radius > 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true && source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else { 
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                            } else {
                                pointStyle = pointStyle_active
                                labelStyle = labelStyle_active
                                source['active'] = true
                            }


                            source['catalog'] = '2FLGC'
                            source['xCanvas'] = point[0]
                            source['yCanvas'] = point[1]

                            // Add the point to the list of points on the canvas
                            points.push(source)

                            // object radius in pixel, could be varable depending on e.g. magnitude
                            var r = Math.pow(parseInt(source.LIKE_BEST_TS_GRB) * 0.5, 0.2);

                            // // draw on canvas
                            // Celestial.setStyle(style_2FLGC);
                            // Celestial.context.beginPath();
                            // Celestial.context.fillText('+', point[0]-5, point[1]+5);
                            // Celestial.context.closePath();
                            // Celestial.context.stroke();
                            // Celestial.context.fill();

                            // draw on canvas
                            Celestial.setStyle(style_2FLGC);
                            Celestial.context.beginPath();
                            Celestial.context.arc(point[0], point[1], r, 0, 2 * Math.PI);
                            Celestial.context.closePath();
                            Celestial.context.stroke();
                            Celestial.context.fill();

                        }

                        if (Celestial.zoomBy() >= 16.0) {

                            Celestial.setTextStyle(labelStyle);
                            Celestial.context.fillText('GRB ' + source.GCNNAME, point[0] + r + 7.5, point[1] + r - 7.5);

                        }

                        if (Celestial.zoomBy() >= 16.0) {

                            // Draw the errors with a less computationally intensive method if only shown when zoomed in
                            if (always_show_errors === false) {

                                var radius_canvas;
                                var test_point1 = Celestial.mapProjection([coordinates[0], coordinates[1]]);
                                var test_point2 = Celestial.mapProjection([coordinates[0], coordinates[1]-(parseFloat(source.ERR))]);
                                var dx = test_point1[0] - test_point2[0];
                                var dy = test_point1[1] - test_point2[1];
                                radius_canvas = Math.sqrt( dx*dx + dy*dy );
                                
                                // draw on canvas
                                Celestial.setStyle(style_2FLGC_error);
                                Celestial.context.beginPath();
                                Celestial.context.setLineDash([5, 5])
                                Celestial.context.arc(point[0], point[1], radius_canvas, 0, 2 * Math.PI);
                                Celestial.context.closePath();
                                Celestial.context.stroke();

                            } else {

                                var error_path = new Array()

                                for (angle = 0; angle < 365; angle+=5) { 

                                    var λ1 = coordinates[0] * deg2rad    // ra (long)
                                    var φ1 = coordinates[1] * deg2rad    // dec (lat) 
                                    var δ = (parseFloat(source.ERR)) * deg2rad             // distance
                                    var θ  = angle * deg2rad                    // bearing

                                    var φ2 = Math.asin( Math.sin(φ1)*Math.cos(δ) + Math.cos(φ1)*Math.sin(δ)*Math.cos(θ) );
                                    var λ2 = λ1 + Math.atan2( Math.sin(θ)*Math.sin(δ)*Math.cos(φ1),Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2) );

                                    var xy = Celestial.mapProjection([λ2/deg2rad, φ2/deg2rad]);

                                    error_path.push(xy)

                                }

                                Celestial.setStyle(style_2FLGC_error);
                                Celestial.context.beginPath();
                                Celestial.context.setLineDash([5, 5])

                                for (j = 0; j < error_path.length-1; j+=1) { 

                                    Celestial.context.moveTo(error_path[j][0], error_path[j][1]);
                                    Celestial.context.lineTo(error_path[j+1][0], error_path[j+1][1]);

                                }

                                // Celestial.context.moveTo(reticale_path[i][0], reticale_path[i][1]);
                                // Celestial.context.lineTo(reticale_path[0][0], reticale_path[0][1]);                

                                Celestial.context.closePath();   
                                Celestial.context.stroke();
 
                            }

                        } 
                    }      
                }
            }

            if (typeof data_IceCube !== 'undefined' && show_IceCube === true) {

                var d = new Date()
                startTime = d.getTime()

                for (i=0; i<data_IceCube.length; i++) {

                    var coordinates
                    var source = data_IceCube[i]

                    TJD_start = convertMET2TJD(MET_start)
                    TJD_stop = convertMET2TJD(MET_stop)

                    // Skip this source if it's outside the temporal search window
                    if ((parseInt(source.DISCOVERY_DATE_TJD) < TJD_start) || (parseInt(source.DISCOVERY_DATE_TJD)) > TJD_stop) {
                        continue
                    }

                    if (config.transform.includes('equatorial')) {
                        coordinates = [source.SRC_RA, source.SRC_DEC]
                    } else if (config.transform.includes('galactic')) {
                        coordinates = calculateGalacticCoordinates(source.SRC_RA, source.SRC_DEC)
                    }

                    // If point is visible (this doesn't work automatically for points)
                    if (Celestial.clip(coordinates)) {

                        var point = Celestial.mapProjection(coordinates);

                        if (point[0] >= 0 && point[0] <= map_width && point[1] >= 0 && point[1] <= map_height) { 

                            // Determine what color this source should be
                            if (perform_search === true) {

                                // Position search only
                                if (search_keyword.length === 0) {
                                    if (source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                                // Keyword search only
                                if (search_radius === 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else {
                                        pointStyle = pointStyle_hidden
                                        labelStyle = labelStyle_hidden
                                        source['active'] = false
                                    }
                                }

                                // Position and keyword search
                                if (search_keyword.length > 0 && search_radius > 0) {
                                    if (sourceIncludesKeyword(source, search_keyword) === true && source.distance <= search_radius) {
                                        pointStyle = pointStyle_active
                                        labelStyle = labelStyle_active
                                        source['active'] = true
                                    } else { 
                                        pointStyle = pointStyle_gray
                                        labelStyle = labelStyle_gray
                                        source['active'] = true
                                    }
                                }

                            } else {
                                pointStyle = pointStyle_active
                                labelStyle = labelStyle_active
                                source['active'] = true
                            }


                            source['catalog'] = 'IceCube'
                            source['xCanvas'] = point[0]
                            source['yCanvas'] = point[1]

                            // Add the point to the list of points on the canvas
                            points.push(source)

                            // object radius in pixel, could be varable depending on e.g. magnitude
                            // var r = Math.pow(20 * 0.5, 0.2);
                            var r = 2.5

                            // draw on canvas
                            Celestial.setStyle(style_IceCube);
                            Celestial.context.beginPath();
                            Celestial.context.arc(point[0], point[1], r, 0, 2 * Math.PI);
                            Celestial.context.closePath();
                            Celestial.context.stroke();
                            Celestial.context.fill();
                        }

                        if (Celestial.zoomBy() >= 16.0) {

                            Celestial.setTextStyle(labelStyle);
                            Celestial.context.fillText(source.NOTICE_TYPE, point[0] + r + 7.5, point[1] + r - 7.5);

                        }

                        if (Celestial.zoomBy() >= 16.0) {

                            // Draw the errors with a less computationally intensive (but less accurate) method if only shown when zoomed in
                            if (always_show_errors === false) {

                                var radius_canvas;
                                var test_point1 = Celestial.mapProjection([coordinates[0], coordinates[1]]);
                                var test_point2 = Celestial.mapProjection([coordinates[0], coordinates[1]-(parseFloat(source.SRC_ERROR)/60.0)]);
                                var dx = test_point1[0] - test_point2[0];
                                var dy = test_point1[1] - test_point2[1];
                                radius_canvas = Math.sqrt( dx*dx + dy*dy );
                                
                                // draw on canvas
                                Celestial.setStyle(style_IceCube_error);
                                Celestial.context.beginPath();
                                Celestial.context.setLineDash([5, 5])
                                Celestial.context.arc(point[0], point[1], radius_canvas, 0, 2 * Math.PI);
                                Celestial.context.closePath();
                                Celestial.context.stroke();
                                // Celestial.context.fill();

                            } else {

                            var error_path = new Array()

                            for (angle = 0; angle < 365; angle+=5) { 

                                var λ1 = coordinates[0] * deg2rad    // ra (long)
                                var φ1 = coordinates[1] * deg2rad    // dec (lat) 
                                var δ = (parseFloat(source.SRC_ERROR)/60.0) * deg2rad             // distance
                                var θ  = angle * deg2rad                    // bearing

                                var φ2 = Math.asin( Math.sin(φ1)*Math.cos(δ) + Math.cos(φ1)*Math.sin(δ)*Math.cos(θ) );
                                var λ2 = λ1 + Math.atan2( Math.sin(θ)*Math.sin(δ)*Math.cos(φ1),Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2) );

                                var xy = Celestial.mapProjection([λ2/deg2rad, φ2/deg2rad]);

                                error_path.push(xy)

                            }

                            Celestial.setStyle(style_IceCube_error);
                            Celestial.context.beginPath();
                            Celestial.context.setLineDash([5, 5])

                            for (j = 0; j < error_path.length-1; j+=1) { 

                                Celestial.context.moveTo(error_path[j][0], error_path[j][1]);
                                Celestial.context.lineTo(error_path[j+1][0], error_path[j+1][1]);

                            }

                            // Celestial.context.moveTo(reticale_path[i][0], reticale_path[i][1]);
                            // Celestial.context.lineTo(reticale_path[0][0], reticale_path[0][1]);                

                            Celestial.context.closePath();   
                            Celestial.context.stroke();
                                                         
                            }





                        } 
                    }      
                }

                var d = new Date()
                endTime = d.getTime()
            }

            // Display the user search coordinates
            if (showReticale == true) {

                var point = Celestial.mapProjection(search_coordinates);
                
                var x = point[0];
                var y = point[1];

                // var radius_canvas;
                // if (isNaN(search_radius)) {
                //     radius_canvas = 0
                // } else {
                //     var test_point1 = Celestial.mapProjection([search_coordinates[0], search_coordinates[1]]);
                //     var test_point2 = Celestial.mapProjection([search_coordinates[0], search_coordinates[1]-search_radius]);
                //     var dx = test_point1[0] - test_point2[0];
                //     var dy = test_point1[1] - test_point2[1];
                //     radius_canvas = Math.sqrt( dx*dx + dy*dy );
                // } 

                // Draw on the canvas
                Celestial.setStyle(reticaleCenterStyle);
                Celestial.context.beginPath();
                Celestial.context.moveTo(x, y - 10);
                Celestial.context.lineTo(x, y + 10);
                Celestial.context.stroke();
                Celestial.context.moveTo(x - 10, y);
                Celestial.context.lineTo(x + 10, y);
                Celestial.context.stroke();
                Celestial.context.closePath();                


                var reticale_path = new Array()

                for (angle = 0; angle < 365; angle+=5) { 

                    var λ1 = search_coordinates[0] * deg2rad    // ra (long)
                    var φ1 = search_coordinates[1] * deg2rad    // dec (lat) 
                    var δ = search_radius * deg2rad             // distance
                    var θ  = angle * deg2rad                    // bearing

                    var φ2 = Math.asin( Math.sin(φ1)*Math.cos(δ) + Math.cos(φ1)*Math.sin(δ)*Math.cos(θ) );
                    var λ2 = λ1 + Math.atan2( Math.sin(θ)*Math.sin(δ)*Math.cos(φ1),Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2) );

                    var xy = Celestial.mapProjection([λ2/deg2rad, φ2/deg2rad]);

                    reticale_path.push(xy)

                }

                Celestial.setStyle(reticaleCircleStyle);
                Celestial.context.beginPath();
                Celestial.context.setLineDash([5, 5])

                for (i = 0; i < reticale_path.length-1; i+=1) { 

                    Celestial.context.moveTo(reticale_path[i][0], reticale_path[i][1]);
                    Celestial.context.lineTo(reticale_path[i+1][0], reticale_path[i+1][1]);

                }

                Celestial.context.moveTo(reticale_path[i][0], reticale_path[i][1]);
                Celestial.context.lineTo(reticale_path[0][0], reticale_path[0][1]);                

                Celestial.context.closePath();   
                Celestial.context.stroke();

                // // Start the drawing path
                // Celestial.setStyle(reticaleCircleStyle);
                // Celestial.context.beginPath();
                // Celestial.context.setLineDash([5, 5])
                // Celestial.context.arc(point[0], point[1], radius_canvas, 0, 2 * Math.PI);
                // Celestial.context.closePath();
                // Celestial.context.stroke();       
            }

            if (showSun == true) {

                if (config.transform.includes('equatorial')) {
                    coordinates = sun_coordinates['equatorial']
                } else {
                    coordinates = sun_coordinates['galactic']
                }

                var point = Celestial.mapProjection(coordinates);

                var x = point[0];
                var y = point[1];

                // Draw on the canvas
                Celestial.setStyle(sunStyle);
                Celestial.context.beginPath();
                Celestial.context.arc(point[0], point[1], 7.5, 0, 2 * Math.PI);
                Celestial.context.closePath();
                Celestial.context.stroke();
                Celestial.context.fill();

                if (Celestial.zoomBy() >= 16.0) {
                    Celestial.setTextStyle(labelStyle);
                    Celestial.context.fillText('Sun', point[0] + r + 7.5, point[1] + r - 7.5);
                } 

            }

            if (showMoon == true) {

                if (config.transform.includes('equatorial')) {
                    coordinates = moon_coordinates['equatorial']
                } else {
                    coordinates = moon_coordinates['galactic']
                }

                var point = Celestial.mapProjection(coordinates);

                var x = point[0];
                var y = point[1];

                // Draw on the canvas
                Celestial.setStyle(moonStyle);
                Celestial.context.beginPath();
                Celestial.context.arc(point[0], point[1], 7.5, 0, 2 * Math.PI);
                Celestial.context.closePath();
                Celestial.context.stroke();
                Celestial.context.fill();

                if (Celestial.zoomBy() >= 16.0) {
                    Celestial.setTextStyle(labelStyle);
                    Celestial.context.fillText('Moon', point[0] + r + 7.5, point[1] + r - 7.5);
                } 

            }

            if (selection.style.visibility === "visible") {
                selection.style.visibility = "hidden";
            }

            if (tooltip_map.style.visibility === "visible") {
                tooltip_map.style.visibility = "hidden";
            }

            // Check to see if a row element is selected. If so, de-select it.
            if ( (previousRowElement != null) && (!previousRowElement.is($(this))) ) {
                previousRowElement.css({ "background-color": previousRowBackgroundColor });
            }
        }

        function get3FGLData(query_ra=NaN, query_dec=NaN, query_radius=NaN, query_keyword="") {

            console.log('Querying the 3FGL database...')

            // Setup the URL
            URL = "queryDB.php?typeOfRequest=SourceList&catalog=3FGL"; 

            if (isNaN(query_ra) !== true && isNaN(query_dec) !== true) {

                var ra_urlEncoded = encodeURIComponent(query_ra);
                var dec_urlEncoded = encodeURIComponent(query_dec);
                URL = URL + "&ra=" + ra_urlEncoded + "&dec=" + dec_urlEncoded

            }

            if (isNaN(query_radius) !== true) {
                
                var radius_urlEncoded = encodeURIComponent(query_radius);
                URL = URL + "&radius=" + radius_urlEncoded

            }

            if (query_keyword.length != 0) {

                var keyword_urlEncoded = encodeURIComponent(query_keyword);
                URL = URL + "&keyword=" + keyword_urlEncoded

            }

            // Print out the final URL
            console.log(URL);

            // Perform an ajax request
            $.ajax({url: URL, success: function(responseText){

                // Get the data
                data_FGL = JSON.parse(responseText);

                // Make a backup of the data array
                data_FGL_original = JSON.parse(JSON.stringify(data_FGL));

                if (data_FGL.length === 0) {
                    alert('Your search found no results!')
                    
                } else {

                    // Fill the primary table
                    fillTable(data_FGL);

                    // Fill the doghnut plot
                    // fillDoughnutPlots(data_FGL);

                }

                return 

            }});
        }

        function get4FGLData(query_ra=NaN, query_dec=NaN, query_radius=NaN, query_keyword="") {

            // Show the map spinner
            $('#map_loading').show()

            console.log('Querying the 4FGL database...')

            // Setup the URL
            URL = "queryDB.php?typeOfRequest=SourceList&catalog=4FGL&magicWord=" + magicWord; 

            if (isNaN(query_ra) !== true && isNaN(query_dec) !== true) {

                var ra_urlEncoded = encodeURIComponent(query_ra);
                var dec_urlEncoded = encodeURIComponent(query_dec);
                URL = URL + "&ra=" + ra_urlEncoded + "&dec=" + dec_urlEncoded

            }

            if (isNaN(query_radius) !== true) {
                
                var radius_urlEncoded = encodeURIComponent(query_radius);
                URL = URL + "&radius=" + radius_urlEncoded

            }

            if (query_keyword.length != 0) {

                var keyword_urlEncoded = encodeURIComponent(query_keyword);
                URL = URL + "&keyword=" + keyword_urlEncoded

            }

            // Print out the final URL
            console.log(URL);

            // Perform an ajax request
            $.ajax({url: URL, success: function(responseText){

                // Get the data
                try {
                    data_FGL = JSON.parse(responseText);
                    console.log("4FGL data length = " + data_FGL.length)
                } catch (error) {
                    console.log('Error parsing query response.')
                    $('#main').hide()
                    return;
                }

                // Make a backup of the data array
                data_FGL_original = JSON.parse(JSON.stringify(data_FGL));

                if (data_FGL.length === 0) {
                    alert('Your search found no results!')
                    
                } else {

                    // Fill the primary table
                    fillTable(data_FGL);

                    // Redraw the map
                    Celestial.redraw()


                    // Show the map spinner
                    $('#map_loading').hide()

                    // Fill the doghnut plot
                    // fillDoughnutPlots(data_FGL);

                }

                // Check if data was successfully retrieved. If the passphrase wasn't set before, set it to the supplied magic_word
                if (data_FGL.length != 0) {
                    if (passphrase == null) {
                        setCookieData('passphrase', magicWord, 1)  // Cookie expires in 1 day
                    }
                }

                return 

            }});
        }

        function get2FAV() {

            console.log('Querying the 2FAV database...')

            // Setup the URL (localhost for testing)
            URL = "http://localhost/~kocevski/FAVADataPortal/queryDB_2FAV_sqlite.php?typeOfRequest=MapData"; 
            
            // Setup the URL (FSSC)
            URL = "https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/queryDB_2FAV.php?typeOfRequest=MapData"

            var ra_urlEncoded = encodeURIComponent(0);
            var dec_urlEncoded = encodeURIComponent(0);
            var radius_urlEncoded = encodeURIComponent(360);
            var threshold_urlEncoded = encodeURIComponent("6Sigma");
            URL = URL + "&ra=" + ra_urlEncoded + "&dec=" + dec_urlEncoded + "&radius=" + radius_urlEncoded + "&threshold=" + threshold_urlEncoded

            // Print out the final URL
            console.log(URL);

            // Perform an ajax request
            $.ajax({url: URL, success: function(responseText){
                
                // Get the data
                try {
                    data_2FAV = JSON.parse(responseText);
                    console.log("2FAV data length = " + data_2FAV.length)
                } catch (error) {
                    console.log('Error parsing query response.')
                    return;
                }

                // Make a backup of the data array
                // data_2FAV_original = JSON.parse(JSON.stringify(data_2FAV));

                if (data_2FAV.length === 0) {
                    alert('Your search found no results!')
                    
                } else {

                    // Fill the primary table
                    fillTable_2FAV(data_2FAV)

                    // Fill the timeline
                    fillTimeline(data_2FAV, '2FAV', null);

                }

                Celestial.redraw()

                return 

            }});
        }

        function get2FLGC() {

            console.log('Querying the 2FLGC database...')

            // Setup the URL
            URL = "queryDB.php?typeOfRequest=SourceList&catalog=2FLGC&magicWord=" + magicWord; 

            // Print out the final URL
            console.log(URL);

            // Perform an ajax request
            $.ajax({url: URL, success: function(responseText){

                // Get the data
                try {
                    data_2FLGC = JSON.parse(responseText);
                    console.log("2FLGC data length = " + data_2FLGC.length)
                } catch (error) {
                    console.log('Error parsing query response.')
                    return;
                }

                // Make a backup of the data array
                data_2FLGC_original = JSON.parse(JSON.stringify(data_2FLGC));

                if (data_2FLGC.length != 0) {
                    
                    // Fill the primary table
                    fillTable_2FLGC(data_2FLGC);

                    // Fill the timeline
                    fillTimeline(data_2FLGC, '2FLGC', 'GRBMET');

                    // // Loop through each data entry and plot the result in the timeline
                    // for (var i=0, size=data_2FLGC.length; i<size; i++) {

                    //     var source = data_2FLGC[i];
                    //     var met = parseFloat(source['GRBMET'])

                    //     var MET_min = 239587201
                    //     var MET_max = 607824005

                    //     var left_percentage = 100 * (met-MET_min)/(MET_max-MET_min) 
                    //     left_percentage = left_percentage.toFixed(2)

                    //     var html_data = '<span class="irs-grid-pol 2FLGC" style="left:' + left_percentage + '%; background-color:rgb(57,142,68, 1); width:1.25px; height:200px; top:50px"</span>'
                    //     $('.irs-line').append(html_data)

                    // }

                }

                Celestial.redraw()
                return 

            }});
        }

        function getIceCube() {


            console.log('Querying the IceCube database...')

            // Setup the URL
            URL = "queryDB.php?typeOfRequest=SourceList&catalog=IceCube&magicWord=" + magicWord; 


            // Print out the final URL
            console.log(URL);

            // Perform an ajax request
            $.ajax({url: URL, success: function(responseText){

                // Get the data
                try {
                    data_IceCube = JSON.parse(responseText);
                    console.log("IceCube data length = " + data_IceCube.length)
                } catch (error) {
                    console.log('Error parsing query response.')
                    return;
                }

                // Make a backup of the data array
                data_IceCube_original = JSON.parse(JSON.stringify(data_IceCube));

                if (data_IceCube.length === 0) {
                    alert('Your search found no results!')
                    
                } else {

                    // Fill the primary table
                    fillTable_IceCube(data_IceCube);

                    // Fill the timeline
                    fillTimeline(data_IceCube, 'IceCube', 'DISCOVERY_DATE_TJD')

                }

                Celestial.redraw()

                return 

            }});
        }

        function fillTimeline(data, name, key) {

            if (name.includes('IceCube')) {

                // Loop through each data entry and plot the result in the timeline
                for (var i=0, size=data.length; i<size; i++) {

                    var source = data[i];
                    var tjd = parseFloat(source[key])

                    var jd = tjd + 2440000.5
                    var mjd = jd - 2400001

                    var mjd_min = 54683
                    var mjd_max = MJD_current

                    var left_percentage = 100 * (mjd-mjd_min)/(mjd_max-mjd_min) 
                    left_percentage = left_percentage.toFixed(2)

                    var html_data = '<span class="irs-grid-pol IceCube" style="left:' + left_percentage + '%; background-color:rgb(215,120,18, 1); width:1.25px; height:200px; top:50px; position:absolute; z-index:100"</span>'
                    $('.irs-line').append(html_data)

                }
            } else if (name.includes('2FLGC')) {

                // Loop through each data entry and plot the result in the timeline
                for (var i=0, size=data.length; i<size; i++) {

                    var source = data[i];
                    var met = parseFloat(source[key])

                    var MET_min = 239587201
                    var MET_max = MET_current

                    var left_percentage = 100 * (met-MET_min)/(MET_max-MET_min) 
                    left_percentage = left_percentage.toFixed(2)

                    var html_data = '<span class="irs-grid-pol 2FLGC" style="left:' + left_percentage + '%; background-color:rgb(57,142,68, 1); width:1.25px; height:200px; top:50px; position:absolute; z-index:101"</span>'
                    $('.irs-line').append(html_data)

                }
            } else if (name.includes('2FAV')) {

                // Loop through each data entry and plot the result in the timeline
                binned_data = {}
                for (var i=0, size=data.length; i<size; i++) {

                    var source = data[i];
                    var met = parseFloat(source['tmin'])

                    if (met in binned_data) {
                        binned_data[met] = binned_data[met] + 1
                    } else {
                        binned_data[met] = 1
                    }

                }

                var max_value = 0
                for (var index in binned_data) {
                    if (binned_data[index] > max_value) {
                        max_value = binned_data[index]
                    }
                }

                var keys = Object.keys(binned_data)
                for (var index in keys) {

                    var met = keys[index]

                    // console.log(met)
                    var MET_min = 239587201.
                    var MET_max = MET_current

                    var left_percentage = 100 * (met-MET_min)/(MET_max-MET_min) 
                    left_percentage = left_percentage

                    counts = binned_data[met]
                    var top_max = 87.
                    var top_min = 0.

                    var top_margin = top_max - ((counts/max_value)*top_max)
                    // console.log(met, counts, left_percentage, top_margin)
                    // var top = parseInt(top_max - (counts/top_max))
                    // console.log(counts, top)

                    var width = 1.90625
                    var width = 2.75
                    var html_data = '<span class="irs-grid-pol 2FAV" style="display:block;left:' + left_percentage + '%; background-color:rgb(233,165,166,1); width:' + width + 'px; height:200px; top:' + top_margin + 'px; position:absolute;"</span>'
                    $('.irs-line').append(html_data)

                }
            }

            // Show the spinner while the data is being loaded
            $('#timeline_spinner').hide()

        }

        function addFakeDataPoint(ra, dec) {

            json_reticale = {
                "type":"FeatureCollection",
                "features":[{
                    "type":"Feature",
                    "id":"reticale",
                    "properties": {
                        "name":"reticale",
                        "mag":30,
                        "dim":10
                    },
                    "geometry": {
                        "type":"Point",
                        "coordinates":[0, 0]
                    }
                }]
            }

            Celestial.add({
                type:"point",

                    callback: function(error, json) {

                        if (error) return console.warn(error);

                        // Load the geoJSON file and transform to correct coordinate system, if necessary
                        var data_reticale = Celestial.getData(json_reticale, config.transform);
                        // var dsos = Celestial.getData(json, config.transform);

                        // Add to celestiasl objects container in d3
                        Celestial.container.selectAll(".data")
                        .data(data_reticale.features)
                        .enter().append("path")
                        .attr("class", "data");

                        // Trigger redraw to display changes
                        Celestial.redraw();
                    },

                redraw: redraw
            });
        }

        function signalAnimationFinish() {

            console.log('animation done.')
            isMapAnimating = false
        }

        function mapSearch() {        

            // Hide the data table and show the loading spinner
            document.getElementById('dataTable_4FGL').style.display = 'none';
            document.getElementById('loadingSpinnerImage').style.display = 'block';

            // Determine which table is currently being displayed
            var activeTabID = $(".nav-tabs.tables > li.active")[0].id

            // Hide the row count and pagination selector, but only if the 4FGL tab is being display
            if (activeTabID.includes('4FGL')) {
                $('.pagination').hide()
                $('#table_row_selector').css("visibility", "hidden");
                $('#table_range_display').hide()
            }

            // Set no limit on the number of rows that can be displayed
            maxNumberOfTableRows = data_FGL.length

            if (config.transform.includes('equatorial')) {

                search_coordinates = [search_ra, search_dec]

            } else if (config.transform.includes('galactic')) {

                search_coordinates = calculateGalacticCoordinates(search_ra, search_dec)
                var gall = search_coordinates[0]
                var galb = search_coordinates[1]

            }

            // Make sure the search radius is always a number
            if (isNaN(search_radius) === true) {
                search_radius = 0
            }

            // Fill the table with all sources that match the search keyword
            if (isNaN(search_ra) === false && isNaN(search_dec) === false) {

                perform_search = true
                showReticale = true

                // Calculate the distance from this point to all catalog points
                for (i=0; i<data_FGL.length; i++) {

                    var source_coordinates;

                    if (config.transform.includes('equatorial')) {
                        source_coordinates = [data_FGL[i].RAJ2000, data_FGL[i].DEJ2000]
                    } else {
                        source_coordinates = [data_FGL[i].GLON, data_FGL[i].GLAT]
                    }

                    data_FGL[i]['distance'] = d3.geo.distance(search_coordinates, source_coordinates) * radians2degrees

                }

                // Sort the data
                // setTimeout(() => { 
                //     data_FGL.sort(function(a, b){return a.distance - b.distance});
                //     shouldDisplayDistance = true;
                //     fillTable(data_FGL)
                //     Celestial.redraw()
                // }, 1000);

                // // Animate the map
                // setTimeout(() => { 
                //     animateMap(search_coordinates)
                // }, 1500);

                // Sort the data
                data_FGL.sort(function(a, b){return a.distance - b.distance});
                shouldDisplayDistance = true;

                // Fill the table and redraw the map
                fillTable(data_FGL)
                Celestial.redraw()

                var scale = Celestial.mapProjection.scale();
                var scale_target = 3169.125;
                var zoom_factor = scale_target/scale

                // Define the animations
                animations = [{
                    'param': 'center',
                    'value': [search_coordinates[0],search_coordinates[1],0],
                    'duration': 500
                }, {
                    'param': 'zoom',
                    'value': zoom_factor,
                    'duration': 500,
                    'callback': signalAnimationFinish                
                }]

                // Animate the map
                isMapAnimating = true;
                Celestial.animate(animations, false)


            } else if (search_keyword.length > 0) {

                perform_search = true;

                // Fill the table with only sources that match the search keyword with no research radius
                fillTable(data_FGL)
                Celestial.redraw()

            }
        }        

        function clearMapSearch() {

            var ra;
            var dec;
            var search_radius;

            var scale = Celestial.mapProjection.scale();
            var scale_target = 198.0703125;
            var zoom_factor = scale_target/scale
            var center_coordinates
            isMapAnimating = true;

            // Clear the input values
            $('#ra_input').val("")
            $('#dec_input').val("")
            $('#radius_input').val("")
            $('#keyword_input').val("")

            if (config.transform.includes('equatorial')) {

                var ra = 0
                var dec = 0
                
                center_coordinates = [ra, dec]

            } else if (config.transform.includes('galactic')) {

                var ra = 266.417
                var dec = -29.007806
                var galacticCoordinates = calculateGalacticCoordinates(ra, dec)
                var gall = galacticCoordinates[0]
                var galb = galacticCoordinates[1]

                center_coordinates = [gall, galb]

            }

            shouldDisplayDistance = false;
            perform_search = false;

            document.getElementById('dataTable_4FGL').style.display = 'none';
            document.getElementById('loadingSpinnerImage').style.display = 'block';

            // setTimeout(() => { 
            //     // get3FGLData()
            //      // data_FGL.sort(function(a, b){return a.RAJ2000 - b.RAJ2000});
            //     data_FGL = JSON.parse(JSON.stringify(data_FGL_original));
            //     fillTable(data_FGL)

            // }, 1000);

            // setTimeout(() => { 
            //     Celestial.rotate({center:[center_coordinates[0],center_coordinates[1],0]})
            //     setTimeout(() => { Celestial.zoomBy(zoom_factor); }, 4800);
            //     setTimeout(() => { isMapAnimating = false }, 4500);
            //     Celestial.redraw()
            // }, 2200);

            // // Reset the data array
            // data_FGL = JSON.parse(JSON.stringify(data_FGL_original));
            // fillTable(data_FGL)

            // // Define the animations
            // animations = [{
            //     'param': 'center',
            //     'value': [center_coordinates[0],center_coordinates[1],0],
            //     'duration': 500,
            //     'callback': soundOff
            // }, {
            //     'param': 'zoom',
            //     'value': zoom_factor,
            //     'duration': 500,
            //     'callback': function() {

            //         data_FGL = JSON.parse(JSON.stringify(data_FGL_original));
            //         fillTable(data_FGL)
                    
            //     }                
            // }]

            // Define the animations
            animations = [{
                'param': 'zoom',
                'value': zoom_factor,
                'duration': 500,
                'callback': function() {
                    data_FGL = JSON.parse(JSON.stringify(data_FGL_original));
                    fillTable(data_FGL);
                    isMapAnimating = false;
                }                
            }]

            // Reset the row counter to reflect the last selection
            maxNumberOfTableRows = $('.dropdown-menu.row_count li.active').val()

            // Show the row count and pagination selector (if the active tab is 4FGL)
            var activeTabID = $(".nav-tabs.tables > li.active")[0].id

            if (activeTabID.includes('4FGL')) {
                $('.pagination').show()
                $('#table_row_selector').css("visibility", "visible");
                $('#table_range_display').show()
            }

            // Animate the map
            Celestial.animate(animations, false)
            Celestial.redraw()
        }

        // Fill the primary table
        function fillTable(data) {

            // Setup the row array
            var row = new Array(), j = -1;

            // Create the header string
            var header = '<tr> \
            <th style="text-align: center; min-width:150px">Source ID</th> \
            <th style="text-align: center;">RA</th> \
            <th style="text-align: center;">Dec</th> \
            <th style="text-align: center;">Gal l</th> \
            <th style="text-align: center;">Gal b</th> \
            <th style="text-align: center;">Association</th> \
            <th style="text-align: center;">Class</th> \
            <th style="text-align: center;">Variability Index</th> \
            <th style="text-align: center; min-width:100px">Photon Flux<BR>1-100 GeV</th> \
            <th style="text-align: center; min-width:100px">Eenrgy Flux<BR>1-100 GeV</th> \
            <th style="text-align: center;">Average Significance</th> \
            <th style="text-align: center;">Spectrum Type</th> \
            <th style="text-align: center;">Spectral Index</th> \
            '

            if (shouldDisplayDistance === true) {
                header = header + '<th style="text-align: center;">Search Distance</th></tr>'
            } else {        
                header = header + '</tr>'
            } 

            classifications = []

            table_columns = ['Source_Name', 'RAJ2000', 'DEJ2000', 'GLON', 'GLAT', 'ASSOC1', 'CLASS1', 'Variability_Index', 'Flux1000', 'Energy_Flux100', 'Signif_Avg', 'SpectrumType', 'Spectral_Index']

            if (shouldDisplayDistance === true) {
                table_columns.push('distance')
            }            

            // Start a counter to record the number of sources that pass the temporal cut
            var number_of_displayed_sources = 0

            // Loop through each data entry and add columns to the corresponding row entry
            for (var i=startingTableRow, size=startingTableRow+maxNumberOfTableRows; i<size; i++) {

                // Make  sure the loop doesn't exceed the data_2FAV_subset length (in case the search finds less than maxNumberOfTableRows flares)
                if (i >= data.length) {
                    break
                }

                var source = data[i];

                if (perform_search === true) {

                    // Position search only
                    if (search_keyword.length === 0) {
                        if (source['distance'] > search_radius) {
                            break 
                        }
                    } 

                    // Keyword search only
                    if (search_radius === 0) {
                        if (sourceIncludesKeyword(source, search_keyword) === false) {
                            continue
                        }
                    }

                    // Position and keyword search
                    if (search_keyword.length > 0 && search_radius > 0) {
                        if (sourceIncludesKeyword(source, search_keyword) === false || source.distance > search_radius) {
                            continue
                        } 
                    }
                }


                row[++j] = '<tr>';

                // Loop through each of the keys in the current record
                for (var index in table_columns) {

                    var key = table_columns[index]

                    // Check to see if the current key is in the list of columns that we want to show
                    if (key === 'Source_Name') {

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';
                        var source_name = source[key].replace(' ','_')
                        if (parseFloat(source['Variability_Index']) >= 18) {
                            row[++j] = '<a href="./source.php?source_name=' + source_name + '">' + source[key] + '</a>';
                        } else {
                            row[++j] = source[key];
                        }

                    } else if (key === 'ASSOC1' || key === 'CLASS1' || key === 'SpectrumType' ) {

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';
                        row[++j] = source[key];

                        if (key == 'CLASS1') {
                            classifications.push(source[key])
                            
                        }                         

                    } else if (key === 'Flux1000' || key === 'Energy_Flux100') {

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';
                        row[++j] = parseFloat(source[key]).toExponential(3);   

                    } else if (key === 'Spectral_Index') {

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';

                        if (source['SpectrumType'].includes('PowerLaw')) {
                            row[++j] = parseFloat(source['PL_Index']).toFixed(3);   
                        } else if (source['SpectrumType'].includes('LogParabola')) {
                            row[++j] = parseFloat(source['LP_Index']).toFixed(3);   
                        } else {
                            row[++j] = parseFloat(source['PLEC_Index']).toFixed(3);   
                        }


                    } else {

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';
                        row[++j] = parseFloat(source[key]).toFixed(3);   

                    }

                    row[++j] = '</td>';

                }

                number_of_displayed_sources = number_of_displayed_sources + 1

            }

            // Add the header to the start of the array
            row.unshift(header);

            // Join the row array into one long string and place it inside the table element
            // $('#dataTable_4FGL').html(row.join('')); 
            console.log('done.')
            document.querySelector('#dataTable_4FGL').innerHTML = row.join(''); 
            
            // Update the table range display
            if (number_of_displayed_sources < maxNumberOfTableRows) {
                $('#table_range_4FGL')[0].innerHTML = 'Showing ' + startingTableRow + ' - ' + (startingTableRow+number_of_displayed_sources) + ' of ' + data.length + ' Sources'
            } else {
                $('#table_range_4FGL')[0].innerHTML = 'Showing ' + startingTableRow + ' - ' + (startingTableRow+maxNumberOfTableRows) + ' of ' + data.length + ' Sources'
            }

            // Hide the spinner
            $("#loadingSpinnerImage").hide();

            // Show the table (if the 4FGL tab is active)
            // Get the active nav tab
            var activeTabID = $(".nav-tabs.tables > li.active")[0].id

            // Update the pagination counts
            if (activeTabID.includes('4FGL')) {
                $("#dataTable_4FGL").show();

                // Update the pagination count
                $('#pagination_end a')[0].innerText = Math.ceil(data.length/maxNumberOfTableRows)

            }

        }

        // Fill the 2FAV table
        function fillTable_2FAV(data) {

            // Setup the row array
            var row = new Array(), j = -1;

            // Create the header string
            var header = '<tr> \
            <th style="text-align: center; min-width:150px">Source ID</th> \
            <th style="text-align: center;">RA</th> \
            <th style="text-align: center;">Dec</th> \
            <th style="text-align: center;">Error</th> \
            <th style="text-align: center;">Gal l</th> \
            <th style="text-align: center;">Gal b</th> \
            <th style="text-align: center;">Date Start</th> \
            <th style="text-align: center;">Date Stop</th> \
            <th style="text-align: center;">Sigma<BR>100-800 MeV</th> \
            <th style="text-align: center;">Sigma<BR>0.8-300 GeV</th> \
            <th style="text-align: center; min-width:160px">Association</th> \
            '

            table_columns = ['flareID', 'best_ra', 'best_dec', 'best_r95', 'gall', 'galb', 'dateStart', 'dateStop', 'le_ffsigma', 'he_ffsigma', 'fglassoc']

            // If no pagination object exists for this table, then start on page 1. Otherwise start where the user previously left off for this table
            if ('2FAV' in paginations) {
                currentTablePage = parseInt($('.pagination li.active a').text())
                startingTableRow = (currentTablePage-1) * maxNumberOfTableRows
            }

            // Loop through the data to pre-select the flares that occured within the temporal search window
            data_2FAV_subset = []
            for (var i=0, size=data.length; i<size; i++) {

                source = data[i]

                var tmin = parseInt(source['tmin'])
                var tmax = parseInt(source['tmax'])

                if ((tmin >= MET_start) && (tmax <= MET_stop)) {

                    data_2FAV_subset.push(source)

                }

            }

            // Start a counter to record the number of sources that pass the temporal cut
            var number_of_displayed_sources = 0

            // Loop through each data entry and add columns to the corresponding row entry
            for (var i=startingTableRow, size=startingTableRow+maxNumberOfTableRows; i<size; i++) {

                // Make  sure the loop doesn't exceed the data_2FAV_subset length (in case the search finds less than maxNumberOfTableRows flares)
                if (i >= data_2FAV_subset.length) {
                    break
                }

                // var source = data[i];
                var source = data_2FAV_subset[i]

                row[++j] = '<tr>';


                // Loop through each of the keys in the current record
                for (var index in table_columns) {

                    var key = table_columns[index]

                    if (key === 'flareID') {

                        var week_number = source[key].split("_")[0]
                        var flare_number = source[key].split("_")[1]

                        var link = 'https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/SourceReport.php?week=' + week_number + '&flare=' + flare_number

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';
                        row[++j] = '<a href="' + link + '" onclick="window.open(this.href,\'targetWindow\'); return false;">' + 'Week ' + week_number + ' Flare ' + flare_number + '</a>';

                    } else {

                        row[++j] ='<td class="' + key + '" style="text-align: center;">';
                        row[++j] = source[key];
                    }

                    row[++j] = '</td>';


                }

                number_of_displayed_sources = number_of_displayed_sources + 1

            }

            // Add the header to the start of the array
            row.unshift(header);

            // Join the row array into one long string and place it inside the table element
            $('#dataTable_2FAV').html(row.join('')); 
            // document.querySelector('#dataTable_2FAV').innerHTML = row.join(''); 

            // Hide the spinner
            $("#loadingSpinnerImage").hide();

            // Update the table range display
            // $('#table_range_2FAV')[0].innerHTML = 'Showing ' + startingTableRow + ' - ' + (startingTableRow+maxNumberOfTableRows) + ' of ' + data_2FAV_subset.length + ' Sources'

            // Update the table range display
            if (number_of_displayed_sources < maxNumberOfTableRows) {
                $('#table_range_2FAV')[0].innerHTML = 'Showing ' + startingTableRow + ' - ' + (startingTableRow+number_of_displayed_sources) + ' of ' + data_2FAV_subset.length + ' Sources'
            } else {
                $('#table_range_2FAV')[0].innerHTML = 'Showing ' + startingTableRow + ' - ' + (startingTableRow+maxNumberOfTableRows) + ' of ' + data_2FAV_subset.length + ' Sources'
            }


            // // Update the pagination count
            // $('#pagination_end a')[0].innerText = String(parseInt(data.length/maxNumberOfTableRows))

        }

       // Fill the 2FAV table
        function fillTable_2FLGC(data) {

            // Setup the row array
            var row = new Array(), j = -1;

            // Create the header string
            var header = '<tr> \
            <th style="text-align: center;min-width:150px">GCN Name</th> \
            <th style="text-align: center;min-width:150px">Date & Time<BR>UTC</th> \
            <th style="text-align: center;">MET</th> \
            <th style="text-align: center;">RA</th> \
            <th style="text-align: center;">Dec</th> \
            <th style="text-align: center;">Error</th> \
            <th style="text-align: center;min-width:100px">GBM T90</th> \
            <th style="text-align: center;">TS</th> \
            <th style="text-align: center; min-width:100px">Energy Flux<BR>1-100 GeV</th> \
            <th style="text-align: center; min-width:125px">Energy Fluence<BR>1-100 GeV</th> \
            '

            table_columns = ['GCNNAME', 'GRBDATE', 'GRBMET', 'RA', 'DEC', 'ERR', 'GBMT90', 'LIKE_BEST_TS_GRB', 'LIKE_BEST_FLUX_ENE', 'LIKE_BEST_FLUENCE_ENE']

            var number_of_displayed_sources = 0
            var number_of_offline_notices = 0

            // Loop through each data entry and add columns to the corresponding row entry
            for (var i=0, size=data.length; i<size; i++) {

                var source = data[i];

                if ((source['GRBMET'] >= MET_start) && (source['GRBMET'] <= MET_stop)) {

                    row[++j] = '<tr>';

                    // Loop through each of the keys in the current record
                    for (var index in table_columns) {

                        var key = table_columns[index]

                        if (key === 'GCNNAME') {

                            var gcnname = source[key]

                            if (gcnname.includes('A') === false && gcnname.includes('B') === false && gcnname.includes('C') === false) {
                                                                
                                if (parseInt(source[key]) < 91128) {
                                    gcnname = parseInt(source[key]).toString()
                                    gcnname = '0' + gcnname
                                }
                            }       

                            var link = 'https://gcn.gsfc.nasa.gov/other/' + gcnname + '.gcn3'

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = '<a href="' + link + '">' + 'GRB ' + gcnname + '</a>';

                        } else if (key === 'Date') {

                            row[++j] ='<td class="' + key + '" style="text-align: center;width:500px">';
                            row[++j] = source[key];     

                        } else if (key === 'GBMT90' || key === 'LIKE_BEST_TS_GRB') {

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';

                            if (source[key] != null) {
                                row[++j] = parseFloat(source[key]).toFixed(2);
                            } else {
                                row[++j] = null;
                                number_of_offline_notices = number_of_offline_notices + 1
                            } 

                        } else if (key === 'LIKE_BEST_FLUX_ENE' || key === 'LIKE_BEST_FLUENCE_ENE') {

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';

                            if (source[key] != null) {
                                row[++j] = parseFloat(source[key]).toExponential(3); 
                            } else {
                                row[++j] = null;
                            }  

                        } else {

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = source[key];
                        }

                        row[++j] = '</td>';

                    }

                    number_of_displayed_sources = number_of_displayed_sources + 1

                }

            }

            // Add the header to the start of the array
            row.unshift(header);

            // Join the row array into one long string and place it inside the table element
            $('#dataTable_2FLGC').html(row.join('')); 
            // document.querySelector('#dataTable_2FLGC').innerHTML = row.join(''); 

            // Hide the spinner
            $("#loadingSpinnerImage").hide();

            // Update the table range display
            $('#table_range_2FLGC')[0].innerHTML = 'Showing ' + number_of_displayed_sources + ' of ' + data.length + ' Sources'

            // Update the number of detections
            $('#number_of_LAT_detections')[0].innerHTML = data.length

        }

       // Fill the 2FAV table
        function fillTable_IceCube(data) {

            // Setup the row array
            var row = new Array(), j = -1;

            // Create the header string
            var header = '<tr> \
            <th style="text-align: center;min-width:100px">Event Number</th> \
            <th style="text-align: center;min-width:150px">Notice Type</th> \
            <th style="text-align: center;">Date<BR>UTC</th> \
            <th style="text-align: center;">Time<BR>UTC</th> \
            <th style="text-align: center;">RA</th> \
            <th style="text-align: center;">Dec</th> \
            <th style="text-align: center;">Error</th> \
            <th style="text-align: center;min-width:100px">Energy<BR>TeV</th> \
            <th style="text-align: center;">FAR<BR>Year<sup>-1</sup></th> \
            '

            table_columns = ['EVENT_NUM', 'NOTICE_TYPE', 'DISCOVERY_DATE', 'DISCOVERY_TIME', 'SRC_RA', 'SRC_DEC', 'SRC_ERROR', 'ENERGY', 'FAR']

            // Start a counter to record the number of sources that pass the temporal cut
            var number_of_displayed_sources = 0

            // Loop through each data entry and add columns to the corresponding row entry
            for (var i=0, size=data.length; i<size; i++) {

                var source = data[i];

                // Get the discovery MET
                discovery_TJD = parseInt(source['DISCOVERY_DATE_TJD'])
                discovery_MET = convertTJD2MET(discovery_TJD)


                // Only show rows that fall within the timeline slider range
                if ((discovery_MET >= MET_start) && (discovery_MET <= MET_stop)) {

                    row[++j] = '<tr>';

                    // Loop through each of the keys in the current record
                    for (var index in table_columns) {

                        var key = table_columns[index]

                        if (key === 'EVENT_NUM') {
                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = '<a href="' + source['URL'] + '" onclick="window.open(this.href,\'targetWindow\'); return false;">' + source[key] + '</a>';


                        } else if (key === 'NOTICE_TYPE') { 

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            // row[++j] = '<a href=#>' + source[key].replace('ICECUBE','') + '</a>';
                            row[++j] = source[key].replace('ICECUBE','')

                        } else if (key === 'Date') {

                            row[++j] ='<td class="' + key + '" style="text-align: center;width:500px">';
                            row[++j] = source[key];     

                        } else if (key === 'GBMT90' || key === 'LIKE_BEST_TS_GRB') {

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = parseFloat(source[key]).toFixed(2); ;  

                        } else if (key === 'LIKE_BEST_FLUX_ENE' || key === 'LIKE_BEST_FLUENCE_ENE') {

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = parseFloat(source[key]).toExponential(3);  

                        } else if (key === 'SRC_ERROR') { 

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = (parseFloat(source[key])/60.0).toFixed(2);

                        } else {

                            row[++j] ='<td class="' + key + '" style="text-align: center;">';
                            row[++j] = source[key];
                        }

                        row[++j] = '</td>';

                    }

                    number_of_displayed_sources = number_of_displayed_sources + 1

                } else {
                    console.log('skipping ' + source)
                }
            }

            // Add the header to the start of the array
            row.unshift(header);

            // Join the row array into one long string and place it inside the table element
            $('#dataTable_IceCube').html(row.join('')); 
            // document.querySelector('#dataTable_2FLGC').innerHTML = row.join(''); 

            // Hide the spinner
            $("#loadingSpinnerImage").hide();

            // Update the table range display
            $('#table_range_IceCube')[0].innerHTML = 'Showing ' + number_of_displayed_sources + ' of ' + data.length + ' Sources'

            // Update the number of detections
            $('#number_of_icecube_detections')[0].innerHTML = data.length

        }

        function fillDoughnutPlots(data) {

            try {
                window.myDoughnut1.destroy();
            } catch(err) {
                //
            }

            // Create random data
            var randomScalingFactor = function() {
                return Math.round(Math.random() * 100);
            };

            // Configure the detector distribution plot
            var config1 = {
                type: 'doughnut',
                data: {
                    datasets: [{
                        // data: [253, 93, 67, 14, 73, 3, 3, 3, 1, 5, 1, 2],
                        data: classificationOccurance,
                        backgroundColor: colors,
                        label: 'Dataset 1'
                    }],

                    // labels: ["fsrq", "none", "bcu", "grb", "bll", "hmb", "rdg", "nlsy1", "pwn", "nov", "psr", "agn"]
                    labels: classificationsUnique
                },
                options: {
                    responsive: true,
                    legend: {
                        display: true,
                        position: 'bottom',                                 
                        labels: { 
                            fontSize: 12,
                            boxWidth: 10,
                            usePointStyle: false,
                            fullWidth: false,
                            fontFamily: 'Helvetica Neue',
                            fontColor: '#333333'
                        }
                    },
                    title: {
                        display: true,
                        text: catalog + ' Classification Distribution',
                        fontFamily: 'Helvetica Neue',
                        fontColor: '#333333',
                        fontSize: 14

                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    },
                    layout: {
                        padding: {
                            top: 0
                        }
                    }
                }
            };

            // Create the detector distribution plot
            var ctx1 = document.getElementById('chart-area_1').getContext('2d');
            window.myDoughnut1 = new Chart(ctx1, config1);
        }

        function sortAscending(a, b) {

            return a.Signif_Avg - b.Signif_Avg
        }

        function sortDescending(a, b) {

            return b.Signif_Avg - a.Signif_Avg
        }

        function convertMJD2Date(mjd) {

            var jd = mjd + 2400001
            var l = jd + 68569;
            var n = Math.floor(Math.floor(4 * l) / 146097);
            l = l - Math.floor((146097 * n + 3) / 4);

            var i = Math.floor(4000 * (l + 1) / 1461001);
            l = l - Math.floor(1461 * i / 4) + 31;

            var j = Math.floor(80 * l / 2447);
            var k = l - Math.floor(2447 * j / 80);

            l = Math.floor(j / 11);
            j = j + 2 - 12 * l;
            i = 100 * (n - 49) + i + l;

            var year = i;
            var month = j;
            var day = Math.floor(k);

            date_string = months[month] + " " + day + ", " + year

            return date_string
        }

        function convertMET2dateObj(MET) {

            // Account for leap seconds
            if (MET>157766400) {MET=MET-1}  // 2005 leap second
            if (MET>252460801) {MET=MET-1}  // 2008 leap second
            if (MET>362793601) {MET=MET-1}  // 2012 leap second
            if (MET>457401601) {MET=MET-1}  // 2015 leap second
            if (MET>504921601) {MET=MET-1}  // 2016 leap second

            // Convert seconds to milliseconds
            var MET = MET * 1000

            // Define the date @ MET = 0
            var date0 = new Date("January 01, 2001 00:00:00 UTC");

            // Get the new date at the specified MET
            var date = new Date(+date0 + MET)

            return date
        }

        function convertMET2Date(MET) {

            // Account for leap seconds
            if (MET>157766400) {MET=MET-1}  // 2005 leap second
            if (MET>252460801) {MET=MET-1}  // 2008 leap second
            if (MET>362793601) {MET=MET-1}  // 2012 leap second
            if (MET>457401601) {MET=MET-1}  // 2015 leap second
            if (MET>504921601) {MET=MET-1}  // 2016 leap second

            // Convert seconds to milliseconds
            var MET = MET * 1000

            // Define the date @ MET = 0
            var date0 = new Date("January 01, 2001 00:00:00 UTC");

            // Get the new date at the specified MET
            var date = new Date(+date0 + MET)

            year = date.getUTCFullYear()
            day = date.getUTCDate()
            month = date.getUTCMonth() + 1;

            date_string = months[month] + " " + day + ", " + year

            return date_string
        }        

        function convertMJD2MET(MJD) {

            // Get the year, month, day for the correspondng MJD
            var JD = MJD + 2400001
            // var JD = MJD + 2400000.5
            // JD = JD + 0.5
            var l = JD + 68569;
            var n = Math.floor(Math.floor(4 * l) / 146097);
            l = l - Math.floor((146097 * n + 3) / 4);

            var i = Math.floor(4000 * (l + 1) / 1461001);
            l = l - Math.floor(1461 * i / 4) + 31;

            var j = Math.floor(80 * l / 2447);
            var k = l - Math.floor(2447 * j / 80);

            l = Math.floor(j / 11);
            j = j + 2 - 12 * l;
            i = 100 * (n - 49) + i + l;

            var year = i;
            var month = j;  
            var day = k;

            var hours = (day % Math.floor(day)) * 24
            var minutes = (hours % Math.floor(hours)) * 60
            var seconds = (minutes % Math.floor(minutes)) * 60
            var milliseconds = (seconds % Math.floor(seconds)) * 1000

            if (isNaN(hours)) {
                hours = 0
            }

            if (isNaN(minutes)) {
                minutes = 0
            }  

            if (isNaN(seconds)) {
                seconds = 0
            }

            if (isNaN(milliseconds)) {
                milliseconds = 0
            }

            // Subtract 1 because the javascript date objects expects months from 0 to 11
            month_index = month - 1

            // Find the mission elapsed time since the MET reference time
            var date = new Date(Date.UTC(year, month_index, day, hours, minutes, seconds, milliseconds))

            var date_MET_reference = new Date(Date.UTC(2001, 0, 1, 0, 0, 0, 0))
            var MET = date - date_MET_reference

            // Convert from milliseconds to seconds
            MET = MET / 1000.

            // Correct for leap seconds
            if (year>2005) { MET+=1} // 2005 leap second
            if (year>2008) { MET+=1 } // 2008 leap second
            if ((month > 6 && year == 2012) || (year > 2012)) { MET+=1 } // 2012 leap second
            if ((month > 6 && year == 2015) || (year > 2015)) { MET+=1 } // 2015 leap second
            if (year>2016) { MET+=1 } // 2016 leap second

            return MET
        }

        // function convertDate2MET(MJD) {

        //     var year = i;
        //     var month = j;
        //     var day = k;

        //     // Find the mission elapsed time since the MET reference time
        //     var date = new Date(Date.UTC(year, month, day, 0, 0, 0, 0))
        //     var date_MET_reference = new Date(Date.UTC(2001, 0, 1, 0, 0, 0, 0))
        //     var MET = date - date_MET_reference

        //     // Convert from milliseconds to seconds
        //     MET = MET / 1000.

        //     // Correct for leap seconds
        //     if (year>2005) { MET+=1} // 2005 leap second
        //     if (year>2008) { MET+=1 } // 2008 leap second
        //     if ((month > 6 && year == 2012) || (year > 2012)) { MET+=1 } // 2012 leap second
        //     if ((month > 6 && year == 2015) || (year > 2015)) { MET+=1 } // 2015 leap second
        //     if (year>2016) { MET+=1 } // 2016 leap second

        //     return MET
        // }

        function convertMET2JD(MET) {

            // Get the date associated with the MET
            date = convertMET2dateObj(MET)

            // Get the date components
            var day = date.getUTCDate();   // Subtracting a day to make results match NASA's xtime results
            var year = date.getUTCFullYear();
            var month = date.getUTCMonth() + 1;    // Adding a month because the javascript date object starts with month 0?

            // Get the julian date from the date components
            // var julianDate = Math.floor((1461 * (year + 4800 + (month - 14) / 12)) / 4 + (367 * (month - 2 - 12 * ((month - 14) / 12))) / 12 - (3 * ((year + 4900 + (month - 14) / 12) / 100)) / 4 + day - 32075);
            var julianDate = (1461 * (year + 4800 + (month - 14) / 12)) / 4 + (367 * (month - 2 - 12 * ((month - 14) / 12))) / 12 - (3 * ((year + 4900 + (month - 14) / 12) / 100)) / 4 + day - 32075

            return julianDate
        }

        function convertMET2MJD(MET) {

            // Get the julian date
            julianDate = convertMET2JD(MET)

            // Calculate the difference between the julian date and the modified julian date
            // modifiedJulianDate = julianDate - 2400000.5
            modifiedJulianDate = julianDate - 2400001 + 0.5

            // modifiedJulianDate = Math.ceil(modifiedJulianDate)

            return modifiedJulianDate
        }

        function convertMET2TJD(MET) {
            // http://www.csgnetwork.com/juliantruncdateconv.html

            TJD = convertMET2MJD(MET) - 40000

            return TJD
        }

        function convertTJD2MET(TJD) {
            // http://www.csgnetwork.com/juliantruncdateconv.html

            MJD = TJD + 40000
            MET = convertMJD2MET(MJD)

            return MET
        }

        // Adopted from http://www.astronomy.villanova.edu/links/jd.htm
        function calculateCD(julianDate) {
           with (Math) {
              X = parseFloat(julianDate)+0.5
              Z = floor(X)
              F = X - Z
              Y = floor((Z-1867216.25)/36524.25)
              A = Z+1+Y-floor(Y/4)
              B = A+1524
              C = floor((B-122.1)/365.25)
              D = floor(365.25*C)
              G = floor((B-D)/30.6001)
              month = (G<13.5) ? (G-1) : (G-13)
              year = (month<2.5) ? (C-4715) : (C-4716)
              month -= 1 // month in JavaScript is from 0 to 11
              UT = B-D-floor(30.6001*G)+F
              day = floor(UT)
              UT -= floor(UT)
              UT *= 24;
              hour = floor(UT)
              UT -= floor(UT)
              UT *= 60
              minute = floor(UT)
              UT -= floor(UT)
              UT *= 60
              second = round(UT)
           }
           cdDate = new Date(Date.UTC(year, month, day, hour, minute, second))
           return cdDate.toGMTString()
        }

        // // Adopted from http://www.astronomy.villanova.edu/links/jd.htm
        // function convertDate2MJD(year, month, day, hour, mintute, second) {
        //    // cdDate = new Date(year, month, day, hours, mintutes, seconds)
        //    // year = cdDate.getYear()          //added + 1900 10/03/2003
        //    // if (year < 1000 ) {year+=1900}  // modified 10/03/2003
        //    // //year = 1900+cdDate.getYear()
        //    // month = cdDate.getMonth() + 1 //getMonth() returns 0-11
        //    // day = cdDate.getDate()
        //    // hour = cdDate.getHours()
        //    // min = cdDate.getMinutes()
        //    // sec = cdDate.getSeconds()
        //    univTime = hour+(mintute/60.)+(second/3600.)
        //    var sign_value
        //    if ((100*year+month-190002.5) >= 0) {sign_value = 1}
        //       else {sign_value = -1}
        //    with (Math) {
        //       part5 = 0.5*sign_value
        //       jd = part1-part2+part3+part4-part5+0.5
        //       mjd = jd - 2400000.5
        //    }
        //    return mjd
        // }

        function changeTable(selectedTab) {

            // Remove any existing selections on the map
            if (selection.style.visibility === "visible") {
                selection.style.visibility = "hidden";
            }

            if (tooltip_map.style.visibility === "visible") {
                tooltip_map.style.visibility = "hidden";
            }

            console.log('changeTable clicked')

            // Get the currently active event
            var activeTab = $(".nav-tabs.tables > li.active")

            var activeTabID
            if (activeTab.length === 0) {
                activeTabID = "#placeholder"
            } else {
                activeTabID = activeTab[0].id
            }

            var selectedTabID = selectedTab[0].id

            // Do nothing if the user selected an active tab
            if (selectedTabID === activeTabID) {

                return false; 

            } else {

                // Show the spinner
                $("#loadingSpinnerImage").show();

                // Remove the active class
                activeTab.removeClass('active')

                // Hide the table associated with the active tab
                activeTableID = "#dataTable_" + activeTabID
                console.log("Hiding: " + activeTableID)
                $(activeTableID).hide();  

                // Activate the selected element
                selectedTab.addClass('active')

                // // Show the table associated with the active tab
                selectedTableID = "#dataTable_" + selectedTabID
                console.log("Showing: " + selectedTableID)

                setTimeout(() => {

                    // Show the table associated with the selected tab
                    $(selectedTableID).show(); 

                    // Hide the spinner
                    $("#loadingSpinnerImage").hide();

                }, 100);

                // Form the active and selected table range IDs
                activeTableRangeID = "#table_range_" + activeTabID
                selectedTableRangeID = "#table_range_" + selectedTabID

                console.log(activeTableRangeID)
                console.log(selectedTableRangeID)

                // Hide the currently active table range element and show the selected table range element
                $(activeTableRangeID).hide();
                $(selectedTableRangeID).show();

                // Save a copy of the active table's pagination element
                paginations[activeTabID] = $('.pagination').clone(true, true);

                // Hide the pagination controls for the GRB and IceCube catalogs
                if (selectedTabID.includes('2FLGC') || selectedTabID.includes('IceCube')) {
                    
                    // $(".pagination").css("visibility", "hidden");
                    $(".pagination").hide()
                    $("#table_row_selector").css("visibility", "hidden");

                } else {

                    // Replace the pagination element if it already exists
                    if (selectedTabID in paginations) {
                        $('.pagination').replaceWith(paginations[selectedTabID])
                    } else {
                        console.log('reseting pagination 1')
                        resetPagination();
                    }

                    console.log("row_selector_has_changed = " + row_selector_has_changed)

                    if (row_selector_has_changed === true) {

                        // Update the pagination counts
                        if (selectedTabID.includes('FGL')) {
                            console.log('refilling the 4FGL tabl')
                            fillTable(data_FGL)
                            resetPagination();
                        } else if (selectedTabID.includes('2FAV')) {
                            console.log('refilling the 2FAV tabl')
                            fillTable_2FAV(data_2FAV)
                            resetPagination();
                        }

                        // Reset the row selector indicator
                        row_selector_has_changed = false
                    }

                    if (selectedTabID.includes('4FGL') && perform_search === true) {

                        console.log('frak')
                        $(".pagination").hide()
                        $("#table_row_selector").css("visibility", "hidden");      

                    } else {

                        console.log('this')
                        $(".pagination").show()
                        $("#table_row_selector").css("visibility", "visible");  
                        resetPagination()                      
                    }


                }

            }             
        }

        function resetPagination() {

            console.log('reseting the pagination!')

            // Set the page number back to the start
            currentTablePage = 1

            // Get the active nav tab
            var activeTabID = $(".nav-tabs.tables > li.active")[0].id

            // Update the pagination counts
            if (activeTabID.includes('4FGL')) {

                var data = data_FGL

            } else if (activeTabID.includes('2FAV')) {

                maxNumberOfTableRows = $('.dropdown-menu.row_count li.active').val()
                var data = data_2FAV_subset
            }

            // Hide the pagination entirely if the row selector has been set to show all sources
            if (maxNumberOfTableRows === -1) {
                $(".pagination").hide()
                return
            } 

            if (maxNumberOfTableRows === 1000) {
                $("#pagination_dots2").hide()
            } 

            // Show all the tabs by default (the parent element is still hidden, though)
            $('#1').show()
            $('#2').show()
            $('#3').show()
            $('#4').show()
            $("#pagination_dots2").show()
            $('#pagination_end').show()

            if (data.length <= maxNumberOfTableRows) {
                console.log(data.length, (maxNumberOfTableRows*1))
                $(".pagination").hide()
                return              
            } else if (data.length <= maxNumberOfTableRows * 2) {
                console.log(data.length, (maxNumberOfTableRows*2))
                $('#3').hide()
                $('#4').hide()
                $("#pagination_dots2").hide()
                $('#pagination_end').hide()
            } else if (data.length <= maxNumberOfTableRows * 3) {
                console.log(data.length, (maxNumberOfTableRows*3))
                $('#4').hide()
                $("#pagination_dots2").hide()
                $('#pagination_end').hide()
            } else if (data.length <= maxNumberOfTableRows * 4) {
                console.log(data.length, (maxNumberOfTableRows*4))
                $("#pagination_dots2").hide()
                $('#pagination_end').hide()
            } else {
                console.log(data.length)
            }

            $(".pagination").show()

            // Reset the pagination values
            $('#1 a')[0].innerText = 1
            $('#2 a')[0].innerText = 2
            $('#3 a')[0].innerText = 3
            $('#4 a')[0].innerText = 4


            // Remove the active state from the currently selected id and add it back to the first id
            $('.pagination li.active').removeClass('active');                    
            $('#1').addClass('active');

            // Update the end pagination count
            $('#pagination_end a')[0].innerText = Math.ceil(data.length/maxNumberOfTableRows)

            // Set the starting row to zero
            startingTableRow = 0            
        }        

        //declare event to run when div is visible
        function isVisible(){

            $("#loadingSpinnerImage").hide();
        }

        function setDefaultDates() {

            // Use the current date as the default
            var date = new Date();

            // Get the date in milliseconds of the MET zero point
            // var date_MET_reference = new Date(Date.UTC(2001, 1, 1, 0, 0, 0, 0))
            var date_MET_reference = new Date('January 1, 2001 00:00:00 GMT');

            // Calculate the MET associated with the current date
            var MET = date - date_MET_reference

            // Convert milliseconds to seconds
            MET = MET / 1000.0

            // Account for leap seconds
            if (MET>157766400) {MET=MET+1}  // 2005 leap second
            if (MET>252460801) {MET=MET+1}  // 2008 leap second
            if (MET>362793601) {MET=MET+1}  // 2012 leap second
            if (MET>457401601) {MET=MET+1}  // 2015 leap second
            if (MET>504921601) {MET=MET+1}  // 2016 leap second

            // Record the current MET and MJD values
            MET_current = MET
            MJD_current = convertMET2MJD(MET_current)

            // Set the default slide values
            MET_start = 239587201
            MET_stop = MET_current

            // Get the currently set data format
            var date_format = $('.dropdown-toggle.date-format')[0].innerText

            // var MET
            if (date_format.includes('MET')) {

                $("#input_sundate")[0].value = parseInt(MET_current)
                $("#input_to")[0].value = MET_current

            } else if (date_format.includes('MJD')) {

                // Set the timeline range
                $('#js-range-slider-id').attr('data-to', parseInt(MJD_current))
                $('#js-range-slider-id').attr('data-max', parseInt(MJD_current))

                // Set the input range
                $("#input_to")[0].value = parseInt(MJD_current)
                $("#input_sundate")[0].value = parseInt(MJD_current)

            } else {

                var year = String(date.getFullYear())
                var month = String(date.getMonth() + 1)
                var day = String(date.getDay())

                if (month.length === 1) {
                    month = '0' + month
                }

                if (day.length === 1) {
                    day = '0' + day
                }

                date_string_current = year + '-' + month + '-' + day 

                $("#input_sundate")[0].value = date_string_current
                $("#input_to")[0].value = date_string_current
            }
        }

        function setSunMoonPositions() {

            // Get the current date format
            var date_format = $('.dropdown-toggle.date-format')[0].innerText

            var MET
            if (date_format.includes('MET')) {

                // Extract the current MJD and convert it into a date
                MET = $("#input_sundate")[0].value
                // MJD = convertMET2MJD(MET)
                // MJD = parseFloat(MJD)

            } else if (date_format.includes('MJD')) {

                // Extract the current MJD and convert it into a date
                MJD = $("#input_sundate")[0].value
                MJD = parseFloat(MJD)
                MET = convertMJD2MET(MJD)
            }

            // Convert the MJD to a date string
            var dateObj = convertMET2dateObj(MET)

            console.log('Setting Sun/Moon position for: ' + MET + ', ' + MJD)
            console.log(dateObj.toGMTString())

            // Calculate the sun position
            var sun_position_equatorial = calculateSunPosition(dateObj)
            var sun_position_galactic = calculateGalacticCoordinates(sun_position_equatorial[0],sun_position_equatorial[1])

            // Calculate the moon position
            var moon_position_equatorial = calculateMoonPosition(dateObj)
            var moon_position_galactic = calculateGalacticCoordinates(moon_position_equatorial[0],moon_position_equatorial[1])

            // Store the Sun position in both equatorial and galactic coordinates
            sun_coordinates = {}
            sun_coordinates['equatorial'] = sun_position_equatorial
            sun_coordinates['galactic'] = sun_position_galactic

            // Store the Moon position in both equatorial and galactic coordinates
            moon_coordinates = {}
            moon_coordinates['equatorial'] = moon_position_equatorial
            moon_coordinates['galactic'] = moon_position_galactic
        }

        // Check for an existing cookie
        function checkCookie() {
            
            // Check if the cookie contains the passphrase data
            passphrase = getCookieData("passphrase");

            console.log("Cookie stored passphrase = " + passphrase)

            if (passphrase == null) {

                // Show the passphrase modal if the cookie doesn't contain the passphrase data
                $('#magic_word_dialog').modal('show');

            } else {

                // Use the passphrase in the cookie to query the trigger list
                magicWord = passphrase;

                // Add the 4FGL data
                get4FGLData()
            }

            // Add the 4FGL data
            // get4FGLData()
        }

        // Query the database when the page is finished loading
        $(function() {

            // Show the loading spinner
            $("#loadingSpinnerImage").show();
            $("#loadingSpinnerImage").focus();

            // Get a reference to the selection circle
            selection = document.getElementById('selection');
            tooltip_map = document.getElementById('tooltip_map');

            // Add a fake data point to initilize d3
            addFakeDataPoint()

            // // Add the 4FGL data
            // get4FGLData()

            // Use the current date for the default date
            setDefaultDates()    

            // Set the default sun position
            setSunMoonPositions()

            // Display the map
            Celestial.display(config);

            // Get the intial map scaling
            scale_initial = Celestial.mapProjection.scale()

            // Bind events to the canvas
            canvas = document.querySelector("canvas")            
            canvas.id = "map_canvas"

            canvas.onmousedown = function(event) {
                selection.style.visibility = "hidden";
                tooltip_map.style.visibility = "hidden";
                isMouseDown = true;
            }

            canvas.onmouseup = function(event) {

                isMouseDown = false;
            };           

            canvas.addEventListener('wheel',function(event){
                event.preventDefault();
                selection.style.visibility = "hidden";
                tooltip_map.style.visibility = "hidden";
            }, false);

            canvas.onmousemove = function(event) {

                if (isMouseDown === false && isMapAnimating === false && show_tooltip === true) {

                    $(this).css('cursor', 'auto');

                    // Prevent default mouse behaviour
                    event.preventDefault();

                    // Get the canvas offset
                    var bounds = canvas.getBoundingClientRect()
                    var x_canvasOffset = bounds.left
                    var y_canvasOffset = bounds.top

                    // Get the mouse coordinates within the canvas
                    var x_mouseWithinCanvas = event.clientX - x_canvasOffset 
                    var y_mouseWithinCanvas = event.clientY - y_canvasOffset 
                    mouseCoordsWithinCanvas = [x_mouseWithinCanvas,y_mouseWithinCanvas];

                    // Get the offset between the relative and absolute mouse position within the page
                    var x_scrollOffset = event.pageX-event.clientX
                    var y_scrollOffset = event.pageY-event.clientY

                    // Define a custom selection offset
                    var x_customSelectionOffset = 29.5
                    var y_customSelectionOffset = 47.5

                    var i;
                    var distances = new Array();
                    
                    if (typeof points !== 'undefined') {

                        for (i=0; i<points.length; i++) {

                            var point = points[i]

                            var distance = Math.sqrt( Math.pow(mouseCoordsWithinCanvas[0] - point.xCanvas, 2) + Math.pow(mouseCoordsWithinCanvas[1] - point.yCanvas, 2) );

                            if (distance < 10 && point.active) {

                                // Show the selection
                                selection.style.visibility = "visible";
                                selection.style.position = "absolute";                          
                                // selection.style.left = (point.xCanvas) + x_canvasOffset + x_scrollOffset - x_customSelectionOffset + "px";
                                // selection.style.top = (point.yCanvas) + y_canvasOffset + y_scrollOffset - y_customSelectionOffset  + "px";
                                selection.style.left = (point.xCanvas) + x_customSelectionOffset + "px";
                                selection.style.top = (point.yCanvas)  + y_customSelectionOffset + "px"

                                // Check to see if a row element is selected. If so, de-select it.
                                if ( (previousRowElement != null) && (!previousRowElement.is($(this))) ) {
                                    previousRowElement.css({ "background-color": previousRowBackgroundColor });
                                }

                                // Extact information from a 3FGL point
                                if (point.catalog.includes('FGL')) {

                                    var Source_Name = point.Source_Name
                                    var RAJ2000 = point.RAJ2000.toFixed(2).toString()
                                    var DEJ2000 = point.DEJ2000.toFixed(2).toString()
                                    var CLASS1 = point.CLASS1
                                    var ASSOC1 = point.ASSOC1

                                    var data_subdirectory = point.Source_Name.substring(6,8)
                                    console.log(point.Source_Name)
                                    var catalog_source_name = point.Source_Name.replace('-','m').replace('.','d').replace(' ','_').replace('+','p')
                                    var source_name_url = point.Source_Name.replace(' ','_')

                                    var link_spectrum_4FGL = "./data/4FGL/4FGL-DR2_spec_v23/" + data_subdirectory + '/' + catalog_source_name + '_spec.pdf'
                                    var link_lightcurve_4FGL = "./data/4FGL/4FGL-DR2_flux_v23/" + data_subdirectory + '/' + catalog_source_name + '_lc.pdf'
                                    var link_lightcurves_LCR = "./source.php?source_name=" + source_name_url
                                    var link_lightcurves_FAVA = "https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/LightCurve.php?ra=" + RAJ2000 + '&dec=' + DEJ2000

                                    var onclick_small_window = "onclick=\"window.open(this.href,'targetWindow','width=800px, height=650px'); return false;"
                                    var onclick_full_window = "onclick=\"window.open(this.href,'targetWindow'); return false;"

                                    var innerHTML =  point.Source_Name
                                    innerHTML =  innerHTML + '<BR>RA: ' + point.RAJ2000.toFixed(2).toString()
                                    innerHTML =  innerHTML + ', Dec: ' + point.DEJ2000.toFixed(2).toString()
                                    innerHTML =  innerHTML + '<BR>Variability Index: ' + parseFloat(point.Variability_Index).toFixed(2).toString()
                                    innerHTML =  innerHTML + '<BR>Classification: ' + point.CLASS1
                                    innerHTML =  innerHTML + '<BR>Association: ' + point.ASSOC1
                                    innerHTML =  innerHTML + '<BR><p></p><a href="' + link_lightcurve_4FGL + '"' + onclick_small_window + '">4FGL Light Curve</a>' 
                                    innerHTML =  innerHTML + ' | <a href="' + link_spectrum_4FGL + '"' + onclick_small_window + '">4FGL Spectrum</a>'

                                    // Add the LCR link
                                    if (parseFloat(point.Variability_Index) > 18.48) {
                                        innerHTML =  innerHTML +'<BR><a href="' + link_lightcurves_LCR + '">LCR Light Curves</a>'
                                    } else {
                                        innerHTML =  innerHTML +'<BR><font color="gray">LCR Light Curves</font>'
                                    }

                                    // Add the FAVA link
                                    innerHTML =  innerHTML + ' | <a href="' + link_lightcurves_FAVA + '"' + onclick_full_window + '"">FAVA Light Curves</a>'


                                    // Define a custom tooltip offset
                                    var x_customTooltipOffset = 95
                                    // var y_customTooltipOffset = 115
                                    var y_customTooltipOffset = 125

                                    // Show the tooltip
                                    tooltip_map.style.visibility = "visible";
                                    tooltip_map.innerHTML = innerHTML;
                                    tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                    tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";


                                // Extact information from a 3FGL point
                                } else if (point.catalog.includes('IceCube')) {

                                    var energy
                                    if (point.ENERGY === null) {
                                        energy = ""
                                    } else {
                                        energy = point.ENERGY + ' TeV'
                                    }

                                    var innerHTML =  point.NOTICE_TYPE
                                    innerHTML =  innerHTML + '<BR>Date: ' + point.DISCOVERY_DATE + ' Time: ' + point.DISCOVERY_TIME
                                    innerHTML =  innerHTML + '<BR>RA: ' + point.SRC_RA.toFixed(2).toString()
                                    innerHTML =  innerHTML + ', Dec: ' + point.SRC_DEC.toFixed(2).toString()
                                    innerHTML =  innerHTML + '<BR>Error: ' + (point.SRC_ERROR/60.).toFixed(2).toString() + ' deg'
                                    innerHTML =  innerHTML + '<BR>Energy: ' + energy
                                    innerHTML =  innerHTML + '<BR>Link: ' + '<a href="' + point.URL + '">' + point.URL.split('/')[4] + '</a>'

                                    // Define a custom tooltip offset
                                    var x_customTooltipOffset = 75
                                    var y_customTooltipOffset = 105

                                    // Show the tooltip
                                    tooltip_map.style.visibility = "visible";
                                    tooltip_map.innerHTML = innerHTML;
                                    tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                    tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";

                                } else if (point.catalog.includes('2FLGC')) {

                                    var innerHTML =  'GRB ' + point.GCNNAME
                                    innerHTML =  innerHTML + '<BR>Date: ' + point.GRBDATE.split(' ')[0] + ' Time: ' + point.GRBDATE.split(' ')[1]
                                    innerHTML =  innerHTML + '<BR>RA: ' + point.RA.toFixed(2).toString()
                                    innerHTML =  innerHTML + ', Dec: ' + point.DEC.toFixed(2).toString()
                                    innerHTML =  innerHTML + '<BR>Error: ' + (point.ERR).toString() + ' deg'
                                    // innerHTML =  innerHTML + '<BR>Event Number: ' + point.EVENT_NUM
                                    innerHTML =  innerHTML + '<BR>TS: ' + parseFloat(point.LIKE_BEST_TS_GRB).toFixed(2).toString()
                                    innerHTML =  innerHTML + '<BR>Link: ' + '<a href="' + '#' + '">' + 'GRB ' + point.GRBNAME + '</a>'

                                    // Define a custom tooltip offset
                                    var x_customTooltipOffset = 75
                                    var y_customTooltipOffset = 105

                                    // Show the tooltip
                                    tooltip_map.style.visibility = "visible";
                                    tooltip_map.innerHTML = innerHTML;
                                    tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                    tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";

                                } else if (point.catalog.includes('2FAV')) {

                                    var week_number = point.flareID.split("_")[0]
                                    var flare_number = point.flareID.split("_")[1]
                                    var link = "https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/SourceReport.php?week=" + week_number + "&flare=" + flare_number

                                    var innerHTML =  'FAVA ' + week_number + '_' + flare_number
                                    innerHTML =  innerHTML + '<BR>Date: ' + point.dateStart
                                    innerHTML =  innerHTML + '<BR>RA: ' + parseFloat(point.best_ra).toFixed(2).toString()
                                    innerHTML =  innerHTML + ', Dec: ' + parseFloat(point.best_dec).toFixed(2).toString()
                                    innerHTML =  innerHTML + '<BR>Error: ' + parseFloat(point.best_r95).toString() + ' deg'
                                    innerHTML =  innerHTML + '<BR>Link: <a href="' + link + '">FAVA Source Report</a>'

                                    // Define a custom tooltip offset
                                    var x_customTooltipOffset = 55
                                    var y_customTooltipOffset = 95

                                    // Show the tooltip
                                    tooltip_map.style.visibility = "visible";
                                    tooltip_map.innerHTML = innerHTML;
                                    tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                    tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";

                                }


                            } 
                        }  
                    }
                }

                // Get the canvas offset
                var bounds = canvas.getBoundingClientRect()
                var x_canvasOffset = bounds.left
                var y_canvasOffset = bounds.top
                
                // Get the mouse coordinates within the canvas
                var x_mouseWithinCanvas = event.clientX - x_canvasOffset
                var y_mouseWithinCanvas = event.clientY - y_canvasOffset 

                // Define a custom selection offset
                var x_customSelectionOffset = 7.5
                var y_customSelectionOffset = 7.5

                // Get the coordinates associated with the current mouse position
                coordinates_projection = Celestial.mapProjection.invert([x_mouseWithinCanvas, y_mouseWithinCanvas]);

                var radec_coordinates;
                if (typeof coordinates_projection !== 'undefined') {

                    if (config.transform.includes('galactic')) {
                        coordinates = astrojs.coords.galactic2equatorial(coordinates_projection[0],coordinates_projection[1]);
                        radec_coordinates = [coordinates.ra, coordinates.dec]
                    } else {
                        radec_coordinates = coordinates_projection
                    }

                    $("#cursor_coordinates")[0].innerHTML = "RA: " + radec_coordinates[0].toFixed(2) + ", Dec: " + radec_coordinates[1].toFixed(2)
                } else {

                    $("#cursor_coordinates")[0].innerHTML = "RA: --, Dec: --"

                    tooltip_map.style.visibility = "hidden";
                    selection.style.visibility = "hidden";                    
                }
            };

            // Hide the tooltip and reset the coordinate display when moving out of the canvas
            $("#map_panel").on('mouseleave', function() {
                tooltip_map.style.visibility = "hidden";
                selection.style.visibility = "hidden";    
                $("#cursor_coordinates")[0].innerHTML = "RA: --, Dec: --"
            });

            $("#search_button").on('click', function() {

                // $("#magic_word_form").submit();
                search_ra = parseFloat($("#ra_input").val())
                search_dec = parseFloat($("#dec_input").val())
                search_radius = parseFloat($("#radius_input").val())
                search_keyword = $("#keyword_input").val().toLowerCase()

                // Do nothing if the form is empty
                if (isNaN(search_ra) === true && isNaN(search_dec) === true && search_keyword.length === 0) {
                    return 
                }

                // $('#clear_button').show();
                $('#clear_button').removeAttr("disabled");
                $("#clear_button").removeClass("btn-default").addClass("btn-danger");

                mapSearch()
            });

            $("#clear_button").on('click', function() {

                $('ra_input').attr('placeholder', '');
                $('dec_input').attr('placeholder', '');
                $('radius_input').attr('placeholder', '');
                $('keyword_input').attr('placeholder', '');



                $('#clear_button').attr("disabled", true);
                $("#clear_button").removeClass("btn-danger").addClass("btn-default");

                showReticale = false;
                clearMapSearch()
            });

            $('.dropdown-menu.transform').on('click', 'li', function() {
                $('.dropdown-menu.transform li.active').removeClass('active');
                $(this).addClass('active');

                // Get the label for the user selected projection and update the dropdown button
                var new_transform_label = $(this).find('a')[0].innerHTML
                $('.dropdown-toggle.transform')[0].innerHTML =  new_transform_label + ' <span class="caret"></span>'

                // Get the new projection designator used by Celestial.js from the element id 
                new_transform = this.id

                // Apply the selection to the map configuration and re-project the map
                config.transform = new_transform

                // Clear the existing data
                Celestial.clear()

                // Add a fake data point to initilize d3
                addFakeDataPoint()

                // Display the map
                Celestial.display(config);
            });

            $('.dropdown-menu.projection').on('click', 'li', function() {
                $('.dropdown-menu.projection li.active').removeClass('active');
                $(this).addClass('active');

                // Get the label for the user selected projection and update the dropdown button
                var new_projection_label = $(this).find('a')[0].innerHTML
                $('.dropdown-toggle.projection')[0].innerHTML =  new_projection_label + ' <span class="caret"></span>'

                // Get the new projection designator used by Celestial.js from the element id 
                new_projection = this.id

                // Apply the selection to the map configuration and re-project the map
                config.projection = new_projection

                // Clear the existing data
                Celestial.clear()

                // Add a fake data point to initilize d3
                addFakeDataPoint()

                // Display the map
                Celestial.display(config);
            });

            $('.map-overlay.lines').change(function() {
                config.lines[this.id].show = this.checked
                Celestial.apply(config)
            }); 

            $('.map-overlay.data').change(function() {
                config[this.id].show = this.checked
                Celestial.apply(config)
            }); 

            $('.map-overlay.popup').change(function() {
                show_tooltip = this.checked

                if (show_tooltip === false) {
                    selection.style.visibility = "hidden";
                    tooltip_map.style.visibility = "hidden";
                    console.log('hiding stuff')

                    // Check to see if another row element is already selected. If so, de-select it.
                    if ( (previousRowElement != null) && (!previousRowElement.is($(this))) ) {
                        previousRowElement.css({ "background-color": previousRowBackgroundColor });
                    }
                }
            }); 

            $('.map-overlay.sun').change(function() {
                showSun = this.checked
                Celestial.redraw()
            }); 

            $('.map-overlay.moon').change(function() {
                showMoon = this.checked
                Celestial.redraw()
            });

            $("#content, #sidebar, #footer" ).mouseenter(function() {
                selection.style.visibility = "hidden";
                tooltip_map.style.visibility = "hidden";
            })

            $('#4FGL_switch').on('click', function() {

                console.log('4FGL Switch clicked')
                if (show_FGL === true) {

                    // Hide the 4FGL data and redraw the map
                    show_FGL = false
                    Celestial.redraw()

                } else {

                    show_FGL = true
                    Celestial.redraw()

                }
            });

            $('#2FAV_switch').on('click', function() {

                console.log('2FAV Switch clicked')

                if (show_2FAV === true) {

                    // Hide the 2FAV data and redraw the map
                    show_2FAV = false
                    Celestial.redraw()

                    // Hide the 2FAV table if it's visible
                    if ($('#dataTable_2FAV').is(":visible")){
                        console.log('Changing to 4FGL')
                        changeTable($('#4FGL'))  
                    }

                    // Remove the 2FAV tab
                    $("#2FAV").remove();

                    // Hide the 2FAV data in the timeline
                    $('.irs-grid-pol.2FAV').remove()

                    if ((show_2FLGC === false) && (show_2FAV === false) && (show_IceCube === false)) {
                        
                        // Hide the timeline
                        $('#timeline').hide()
                    }

                } else {

                    // Add a 2FAV tab to the list of available data tables
                    var html = '<li id="2FAV" target="event_display" class="navtab catalogs"><a href="#" onclick="return false;">2FAV</a></li>'
                    $("#catalog_tabs").append(html);

                    // Reset the mousedown event binding
                    $(".navtab.catalogs").mousedown( function() { changeTable($(this)); })

                    // Get the 2FAV data
                    get2FAV()

                    // Show the 2FAV data and redraw the map
                    show_2FAV = true
                    Celestial.redraw()

                    // Show the timeline
                    $('#timeline').show()

                    // Show the spinner while the data is being loaded
                    $('#timeline_spinner').show()

                }
            });

            $('#2FLGC_switch').on('click', function() {

                console.log('2FLGC Switch clicked')

                if (show_2FLGC === true) {

                    // Hide the 2FAV data and redraw the map
                    show_2FLGC = false
                    Celestial.redraw()

                    // Hide the 2FLGC table if it's visible
                    if ($('#dataTable_2FLGC').is(":visible")){
                        console.log('Changing to 4FGL')
                        changeTable($('#4FGL'))
                    }

                    // Remove the 2FAV tab
                    $("#2FLGC").remove();

                    // Hide the 2FLGC data in the timeline
                    $('.irs-grid-pol.2FLGC').remove()

                    if ((show_2FLGC === false) && (show_2FAV === false) && (show_IceCube === false)) {

                        // Hide the timeline
                        $('#timeline').hide()
                    }


                } else {

                    // Add a 2FAV tab to the list of available data tables
                    var html = '<li id="2FLGC" target="event_display" class="navtab catalogs"><a href="#" onclick="return false;">2FLGC</a></li>'
                    $("#catalog_tabs").append(html);

                    // Reset the mousedown event binding
                    $(".navtab.catalogs").mousedown( function() { changeTable($(this)); })

                    // Get the 2FLGC data
                    get2FLGC()

                    // Show the 2FLGC data and redraw the map
                    show_2FLGC = true
                    Celestial.redraw()

                    // Show the timeline
                    $('#timeline').show()

                    // Show the spinner while the data is being loaded
                    $('#timeline_spinner').show()

                    // // Asynchronous update the timeline slider dates 
                    // setTimeout(() => { 

                    //     // Convert from MJD to calender date
                    //     var date_string = convertMJD2Date(date_from)
                    //     console.log(date_string)
                    //     $('.irs-from')[0].innerHTML = date_string

                    //     // Convert from MJD to calender date
                    //     var date_string = convertMJD2Date(date_to)
                    //     console.log(date_string)
                    //     $('.irs-to')[0].innerHTML = date_string


                    // }, 300);

                }
            });

            $('#IceCube_switch').on('click', function() {

                console.log('IceCube Switch clicked')

                if (show_IceCube === true) {

                    // Hide the 2FAV data and redraw the map
                    show_IceCube = false
                    Celestial.redraw()

                    // Hide the 2FLGC table if it's visible
                    if ($('#dataTable_IceCube').is(":visible")){
                        console.log('Changing to 4FGL')
                        changeTable($('#4FGL'))  
                    }

                    // Remove the 2FAV tab
                    $("#IceCube").remove(); 

                    // Hide the IceCube data in the timeline
                    $('.irs-grid-pol.IceCube').remove()

                    if ((show_2FLGC === false) && (show_2FAV === false) && (show_IceCube === false)) {
                        
                        // Hide the timeline
                        $('#timeline').hide()
                    }

                } else {

                    // Add a IceCube tab to the list of available data tables
                    var html = '<li id="IceCube" target="event_display" class="navtab catalogs"><a href="#" onclick="return false;">IceCube</a></li>'
                    $("#catalog_tabs").append(html);

                    // Reset the mousedown event binding
                    $(".navtab.catalogs").mousedown( function() { changeTable($(this)); })

                    // Get the IceCube data
                    getIceCube()

                    // Show the IceCube data and redraw the map
                    show_IceCube = true
                    Celestial.redraw()

                    // Show the timeline
                    $('#timeline').show()
                    
                    // Show the spinner while the data is being loaded
                    $('#timeline_spinner').show()

                }
            });

            $('.dropdown-menu.date-format').on('click', 'li', function() {

                $('.dropdown-menu.date-format li.active').removeClass('active');
                $(this).addClass('active');

                // Get the label for the user selected projection and update the dropdown button
                var new_date_format_label = $(this).find('a')[0].innerHTML
                $('.dropdown-toggle.date-format')[0].innerHTML =  new_date_format_label + ' <span class="caret"></span>'

                // var grid_text_elements =$('.irs-grid-text')
                // for (i=0; i<grid_text_elements.length; i++) {

                //     // Get the MJD label
                //     var label_mjd = grid_text_elements[i].innerHTML
                //     var MJD = parseInt(label_mjd)

                //     // Calculate the corresponding MET
                //     var MET = convertMJD2MET(MJD)

                //     // Rename the label to MET
                //     grid_text_elements[i].innerHTML = MET

                //     console.log(MET)

                // }  

                let timeline_slider = $(".js-range-slider").data("ionRangeSlider");

                from_time = timeline_slider.result['from']
                to_time = timeline_slider.result['to']
                min_time = timeline_slider.result['min']
                max_time = timeline_slider.result['max']

                console.log('from_time = ' + from_time)


                if (new_date_format_label.includes('MET')) {

                    // Convert the relevant times from MJD to MET
                    var from_MET = convertMJD2MET(from_time)
                    var to_MET = convertMJD2MET(to_time)
                    var min_MET = convertMJD2MET(min_time)
                    var max_MET = convertMJD2MET(max_time)

                    timeline_slider.update({
                        min: min_MET,
                        max: max_MET,
                        from: from_MET,
                        to: to_MET
                    });

                    from_input = parseInt($('.form-control.input.from')[0].value)
                    to_input= parseInt($('.form-control.input.to')[0].value)
                    sun_input = parseFloat($('#input_sundate')[0].value)

                    if (to_input < 239587201) {

                        $('.form-control.input.from')[0].value = parseInt(convertMJD2MET(from_input))
                        $('.form-control.input.to')[0].value = parseInt(convertMJD2MET(to_input))
                        $('#input_sundate')[0].value = parseInt(convertMJD2MET(sun_input))

                    }

                    $('#timeline_label').text('Mission Elapsed Time')
                }

                if (new_date_format_label.includes('MJD')) {

                    // Convert the relevant times from MJD to MET
                    var from_MJD = convertMET2MJD(from_time)
                    var to_MJD = convertMET2MJD(to_time)
                    var min_MJD = convertMET2MJD(min_time)
                    var max_MJD = convertMET2MJD(max_time)

                    timeline_slider.update({
                        min: min_MJD,
                        max: max_MJD,
                        from: from_MJD,
                        to: to_MJD
                    });


                    from_input = parseInt($('.form-control.input.from')[0].value)
                    to_input= parseInt($('.form-control.input.to')[0].value)
                    sun_input = parseFloat($('#input_sundate')[0].value)

                    if (to_input > 239587201) {

                        $('.form-control.input.from')[0].value = parseInt(convertMET2MJD(from_input))
                        $('.form-control.input.to')[0].value = parseInt(convertMET2MJD(to_input))
                        $('#input_sundate')[0].value = parseInt(convertMET2MJD(sun_input))

                    } 

                    $('#timeline_label').text('Modified Julian Date')
                }

                $(".nav-tabs.tables li") .each(function() {

                    if ($(this)[0].id.includes('IceCube')) {
                        fillTimeline(data_IceCube, 'IceCube', 'DISCOVERY_DATE_TJD')

                    } else if ($(this)[0].id.includes('2FLGC')) {
                        fillTimeline(data_2FLGC, '2FLGC', 'GRBMET')

                    } else if ($(this)[0].id.includes('2FAV')) {

                        fillTimeline(data_2FAV, '2FAV', null)
                    }
                });


                // // Make sure the y-axis ticks are still there after updating the timeline
                $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-35px;top:20px;">0</span>')
                $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-40px;top:-60px;">10</span>')
                $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')
                $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:-200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')


                // Redraw the map
                Celestial.redraw()
            });

            // Create the timeline slider
            $(".js-range-slider").ionRangeSlider({

                onStart: function (data) {

                    // Called right after range slider instance initialised
            
                    // console.log(data.input);        // jQuery-link to input
                    // console.log(data.slider);       // jQuery-link to range sliders container
                    // console.log(data.min);          // MIN value
                    // console.log(data.max);          // MAX values
                    // console.log(data.from);         // FROM value
                    // console.log(data.from_percent); // FROM value in percent
                    // console.log(data.from_value);   // FROM index in values array (if used)
                    // console.log(data.to);           // TO value
                    // console.log(data.to_percent);   // TO value in percent
                    // console.log(data.to_value);     // TO index in values array (if used)
                    // console.log(data.min_pretty);   // MIN prettified (if used)
                    // console.log(data.max_pretty);   // MAX prettified (if used)
                    // console.log(data.from_pretty);  // FROM prettified (if used)
                    // console.log(data.to_pretty);    // TO prettified (if used)

                    // // Convert the starting MJD to calender date
                    // var date_string = convertMJD2Date(data.from)
                    // $('.irs-from')[0].innerHTML = date_string

                    // // Convert the ending MJD to calender date
                    // var date_string = convertMJD2Date(data.to)
                    // $('.irs-to')[0].innerHTML = date_string

                    // console.log($('.irs-to')[0].innerHTML)

                    date_to = data.to
                    date_from = data.from

                },
            
                onChange: function (data) {
                    // Called every time handle position is changed
            
                    console.log('onChange')

                    // JD
                    if (data.to > 239587201) {

                        // Convert from MJD to calender date
                        var date_to = convertMET2Date(data.to)
                        $('.irs-to')[0].innerHTML = date_to

                        // Convert from MJD to calender date
                        var date_from = convertMET2Date(data.from)
                        $('.irs-from')[0].innerHTML = date_from

                        // Set the upper and lower range of the search MET
                        MET_start = data.from
                        MET_end = data.to

                        var dt = data.to-data.from

                        if (dt < 3.154e+7) {
                            combined_string = date_to + " - " + date_from
                            $('.irs-single').width(175)
                            $('.irs-single')[0].innerHTML = combined_string
                        }

                        // Update the input forms
                        $('.form-control.input.from')[0].value = data.from
                        $('.form-control.input.to')[0].value = data.to 

                    // MJD
                    } else {

                        // Convert from MJD to calender date
                        var date_to = convertMJD2Date(data.to)
                        $('.irs-to')[0].innerHTML = date_to

                        // Convert from MJD to calender date
                        var date_from = convertMJD2Date(data.from)
                        $('.irs-from')[0].innerHTML = date_from

                        var dt = data.to-data.from

                        if (dt < 350) {
                            combined_string = date_to + " - " + date_from
                            $('.irs-single').width(175)
                            $('.irs-single')[0].innerHTML = combined_string
                        }

                        combined_string = $('.irs-single')[0].innerHTML

                        // Set the upper and lower range of the search MET
                        MET_start = convertMJD2MET(data.from)
                        MET_stop = convertMJD2MET(data.to)

                        // Update the input forms
                        $('.form-control.input.from')[0].value = data.from
                        $('.form-control.input.to')[0].value = data.to 

                    }

                },
            
                onFinish: function (data) {

                    // Redraw the map
                    Celestial.redraw()

                    // Refill any existing data tables
                    if (show_2FLGC === true) {
                        fillTable_2FLGC(data_2FLGC)
                    }
                    if (show_IceCube === true) {
                        fillTable_IceCube(data_IceCube)
                    }
                    if (show_2FAV === true) {
                        fillTable_2FAV(data_2FAV)

                    // Reset the pagination if the 2FAV tab is active
                    var activeTabID = $(".nav-tabs.tables > li.active")[0].id

                    if (activeTabID.includes('2FAV')) {
                        resetPagination()
                    }


                    }
  
                    // Called then action is done and mouse is released
                    console.log('onFinish')

                },
            
                onUpdate: function (data) {


                    // JD
                    if (data.to > 239587201) {

                        // Convert from MJD to calender date
                        var date_to = convertMET2Date(data.to)
                        $('.irs-to')[0].innerHTML = date_to

                        // Convert from MJD to calender date
                        var date_from = convertMET2Date(data.from)
                        $('.irs-from')[0].innerHTML = date_from

                        // Set the upper and lower range of the search MET
                        MET_start = data.from
                        MET_end = data.to

                        var dt = data.to-data.from

                        if (dt < 3.154e+7) {
                            combined_string = date_to + " - " + date_from
                            $('.irs-single').width(175)
                            $('.irs-single')[0].innerHTML = combined_string
                        }

                    // MJD
                    } else {

                        // Convert from MJD to calender date
                        var date_to = convertMJD2Date(data.to)
                        $('.irs-to')[0].innerHTML = date_to

                        // Convert from MJD to calender date
                        var date_from = convertMJD2Date(data.from)
                        $('.irs-from')[0].innerHTML = date_from

                        var dt = data.to-data.from

                        if (dt < 350) {
                            combined_string = date_to + " - " + date_from
                            $('.irs-single').width(175)
                            $('.irs-single')[0].innerHTML = combined_string
                        }

                        combined_string = $('.irs-single')[0].innerHTML

                        // Set the upper and lower range of the search MET
                        MET_start = convertMJD2MET(data.from)
                        MET_stop = convertMJD2MET(data.to)

                    }

                    // Redraw the map
                    Celestial.redraw()

                    // Called when slider is changed using Update public method
                    console.log('onUpdate')

                },
            });

            // // Change the timeline background
            $('.irs-grid-pol').css('background-color', '#a6a6a6');

            // // Rotate the timeline elements
            $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-35px;top:20px;">0</span>')
            $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-40px;top:-60px;">10</span>')
            $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')
            $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:-200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')
    

            // Add an mouse click event listener for the data tables
            $('.data-table').on('click', 'tbody tr', function(event) {

                // Check to see if another row element is already selected. If so, de-select it.
                if ( (previousRowElement != null) && (!previousRowElement.is($(this))) ) {
                    previousRowElement.css({ "background-color": previousRowBackgroundColor });
                }

                if( $(this).css('background-color') == "rgb(227, 239, 255)") {

                    // Change the color of the selected row back to white and remove the tool tip
                    //$(this).css({ "background-color": "#ffffff" });
                    // $(this).css({ "background-color": "#f8f8f8" });
                    $(this).css({ "background-color": previousRowBackgroundColor });
                    previousRowElement = null;
                    previousRowBackgroundColor = null;

                    if (selection.style.visibility === "visible") {
                        selection.style.visibility = "hidden";
                    }

                    if (tooltip_map.style.visibility === "visible") {
                        tooltip_map.style.visibility = "hidden";
                    }


                } else {

                    // Save the selected row details
                    previousRowElement = $(this);
                    previousRowBackgroundColor = $(this).css("background-color");

                   // Change the color of the select row to light blue
                    $(this).css({ "background-color": "#E3EFFF" });

                    // Determine which table is currently being displayed
                    var activeTabID = $(".nav-tabs.tables > li.active")[0].id

                    console.log($(this))

                    var sourceName

                    if (activeTabID.includes('4FGL')) {

                        // Extract the source name
                        sourceName = $(this).find("td").eq(0).text();
                        console.log('sourceName = ' + sourceName)


                    } else if (activeTabID.includes('2FAV')) {

                        // Extract the source name
                        sourceName = $(this).find("td").eq(0).html();
                        sourceName = $(sourceName).text()
                        console.log('sourceName = ' + sourceName)

                    } else if (activeTabID.includes('2FLGC')) { 

                        sourceName = $(this).find("td").eq(0).html();
                        sourceName = $(sourceName).text()

                    } else {

                        console.log('sourceName = ' + sourceName)
                        sourceName = $(this).find("td").eq(0).html();
                        sourceName = $(sourceName).text()

                    }

                    // Extract the rest of the source information
                    var sourceRA = $(this).find("td").eq(1).html(); 
                    var sourceDec = $(this).find("td").eq(2).html(); 
                    var sourceGlon = $(this).find("td").eq(3).html(); 
                    var sourceGlat = $(this).find("td").eq(4).html(); 

                    // Get the source coordinates
                    if (config.transform.includes('equatorial')) {
                        coordinates = [sourceRA, sourceDec]
                    } else if (config.transform.includes('galactic')) {
                        coordinates = calculateGalacticCoordinates(sourceGlat, sourceGlon)
                    }

                    // Convert the coordinates into the canvas coordinate system
                    var coordinates_canvas = Celestial.mapProjection(coordinates);

                    // Get the canvas offset
                    var bounds = canvas.getBoundingClientRect()
                    var x_canvasOffset = bounds.left
                    var y_canvasOffset = bounds.top

                    // Get the mouse coordinates within the canvas
                    var x_mouseWithinCanvas = event.clientX - x_canvasOffset 
                    var y_mouseWithinCanvas = event.clientY - y_canvasOffset 
                    mouseCoordsWithinCanvas = [x_mouseWithinCanvas,y_mouseWithinCanvas];

                    // Get the offset between the relative and absolute mouse position within the page
                    var x_scrollOffset = event.pageX-event.clientX
                    var y_scrollOffset = event.pageY-event.clientY

                    // Define a custom selection offset
                    var x_customSelectionOffset = 29.5
                    var y_customSelectionOffset = 47.5

                    // Find the distance of each point from the user selected coordinates and show a tool tip at the closest point
                    for (i=0; i<points.length; i++) {

                        point = points[i]

                        var point_source_name;
                        if (point.catalog.includes('FGL')) {
                            point_source_name = point.Source_Name

                        } else if (point.catalog.includes('2FAV')) {

                            var week_number = point.flareID.split("_")[0]
                            var flare_number = point.flareID.split("_")[1]
                            point_source_name = 'Week ' + week_number + ' Flare ' + flare_number

                        } else if (point.catalog.includes('2FLGC')) {

                            if (point.GCNNAME.includes('.')) {
                                point_source_name = String(parseInt(point.GCNNAME))
                                point_source_name = '0' + point_source_name 
                                point_source_name = 'GRB ' + point_source_name
                            } else {
                                point_source_name = 'GRB ' + point.GCNNAME
                            }

                        } else if (point.catalog.includes('IceCube')) {

                            point_source_name = point.EVENT_NUM
                        }

                        if (point_source_name.includes(sourceName)) {

                            var m = Celestial.metrics(), // Get the current map size in pixels

                            // empty quadtree, will be used for proximity check
                            quadtree = d3.geom.quadtree().extent([[-1, -1], [m.width + 1, m. height + 1]])([]);

                            map_width = m.width;
                            map_height = m.height;

                            if (Celestial.clip(coordinates)) {

                                var coordinates_canvas = Celestial.mapProjection(coordinates);

                                if (coordinates_canvas[0] >= 0 && coordinates_canvas[0] <= map_width && coordinates_canvas[1] >= 0 && coordinates_canvas[1] <= map_height) { 

                                    // Show the selection
                                    selection.style.visibility = "visible";
                                    selection.style.position = "absolute";                          
                                    selection.style.left = (point.xCanvas) + x_customSelectionOffset + "px";
                                    selection.style.top = (point.yCanvas)  + y_customSelectionOffset + "px"

                                    // Extact information from a 3FGL point
                                    if (point.catalog.includes('FGL')) {

                                        var Source_Name = point.Source_Name
                                        var RAJ2000 = point.RAJ2000.toFixed(2).toString()
                                        var DEJ2000 = point.DEJ2000.toFixed(2).toString()
                                        var CLASS1 = point.CLASS1
                                        var ASSOC1 = point.ASSOC1

                                        var data_subdirectory = point.Source_Name.substring(6,8)
                                        var catalog_source_name = point.Source_Name.replace('-','m').replace('.','d').replace(' ','_').replace('+','p')

                                        var link_spectrum_4FGL = "./data/4FGL/4FGL-DR2_spec_v23/" + data_subdirectory + '/' + catalog_source_name + '_spec.pdf'
                                        var link_lightcurve_4FGL = "./data/4FGL/4FGL-DR2_flux_v23/" + data_subdirectory + '/' + catalog_source_name + '_lc.pdf'
                                        var link_lightcurves_LCR = "./source.php"
                                        var link_lightcurves_FAVA = "https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/LightCurve.php?ra=" + RAJ2000 + '&dec=' + DEJ2000

                                        var onclick_small_window = "onclick=\"window.open(this.href,'targetWindow','width=800px, height=650px'); return false;"
                                        var onclick_full_window = "onclick=\"window.open(this.href,'targetWindow'); return false;"

                                        var innerHTML =  point.Source_Name
                                        innerHTML =  innerHTML + '<BR>RA: ' + point.RAJ2000.toFixed(2).toString()
                                        innerHTML =  innerHTML + ', Dec: ' + point.DEJ2000.toFixed(2).toString()
                                        innerHTML =  innerHTML + '<BR>Variability Index: ' + parseFloat(point.Variability_Index).toFixed(2).toString()
                                        innerHTML =  innerHTML + '<BR>Classification: ' + point.CLASS1
                                        innerHTML =  innerHTML + '<BR>Association: ' + point.ASSOC1
                                        innerHTML =  innerHTML + '<BR><p></p><a href="' + link_lightcurve_4FGL + '"' + onclick_small_window + '">4FGL Light Curve</a>' 
                                        innerHTML =  innerHTML + ' | <a href="' + link_spectrum_4FGL + '"' + onclick_small_window + '">4FGL Spectrum</a>'

                                        // Add the LCR link
                                        if (parseFloat(point.Variability_Index) > 18.48) {
                                            innerHTML =  innerHTML +'<BR><a href="' + link_lightcurves_LCR + '">LCR Light Curves</a>'
                                        } else {
                                            innerHTML =  innerHTML +'<BR><font color="gray">LCR Light Curves</font>'
                                        }

                                        // Add the FAVA link
                                        innerHTML =  innerHTML + ' | <a href="' + link_lightcurves_FAVA + '"' + onclick_full_window + '"">FAVA Light Curves</a>'


                                        // Define a custom tooltip offset
                                        var x_customTooltipOffset = 87.5
                                        var y_customTooltipOffset = 105

                                        // Show the tooltip
                                        tooltip_map.style.visibility = "visible";
                                        tooltip_map.innerHTML = innerHTML;
                                        tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                        tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";


                                    // Extact information from a 3FGL point
                                    } else if (point.catalog.includes('IceCube')) {

                                        var energy
                                        if (point.ENERGY === null) {
                                            energy = ""
                                        } else {
                                            energy = point.ENERGY + ' TeV'
                                        }

                                        var innerHTML =  point.NOTICE_TYPE
                                        innerHTML =  innerHTML + '<BR>Date: ' + point.DISCOVERY_DATE
                                        innerHTML =  innerHTML + '<BR>Time: ' + point.DISCOVERY_TIME
                                        innerHTML =  innerHTML + '<BR>RA: ' + point.SRC_RA.toFixed(2).toString()
                                        innerHTML =  innerHTML + ', Dec: ' + point.SRC_DEC.toFixed(2).toString()
                                        innerHTML =  innerHTML + '<BR>Error: ' + (point.SRC_ERROR/60.).toFixed(2).toString() + ' deg'
                                        innerHTML =  innerHTML + '<BR>Energy: ' + energy
                                        innerHTML =  innerHTML + '<BR>Link: ' + '<a href="' + point.URL + '">' + point.URL.split('/')[4] + '</a>'

                                        // Define a custom tooltip offset
                                        var x_customTooltipOffset = 75
                                        var y_customTooltipOffset = 105

                                        // Show the tooltip
                                        tooltip_map.style.visibility = "visible";
                                        tooltip_map.innerHTML = innerHTML;
                                        tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                        tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";

                                    } else if (point.catalog.includes('2FLGC')) {

                                        var innerHTML =  point_source_name
                                        innerHTML =  innerHTML + '<BR>Date: ' + point.GRBDATE.split(' ')[0] + ' Time: ' + point.GRBDATE.split(' ')[1]
                                        innerHTML =  innerHTML + '<BR>RA: ' + point.RA.toFixed(2).toString()
                                        innerHTML =  innerHTML + ', Dec: ' + point.DEC.toFixed(2).toString()
                                        innerHTML =  innerHTML + '<BR>Error: ' + (point.ERR).toString() + ' deg'
                                        // innerHTML =  innerHTML + '<BR>Event Number: ' + point.EVENT_NUM
                                        innerHTML =  innerHTML + '<BR>TS: ' + parseFloat(point.LIKE_BEST_TS_GRB).toFixed(2).toString()
                                        innerHTML =  innerHTML + '<BR>Link: ' + '<a href="' + '#' + '">' + point.GRBNAME + '</a>'

                                        // Define a custom tooltip offset
                                        var x_customTooltipOffset = 75
                                        var y_customTooltipOffset = 105

                                        // Show the tooltip
                                        tooltip_map.style.visibility = "visible";
                                        tooltip_map.innerHTML = innerHTML;
                                        tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                        tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";

                                    } else if (point.catalog.includes('2FAV')) {

                                        var week_number = point.flareID.split("_")[0]
                                        var flare_number = point.flareID.split("_")[1]
                                        var link = "https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/SourceReport.php?week=" + week_number + "&flare=" + flare_number

                                        var innerHTML =  'FAVA ' + week_number + '_' + flare_number
                                        innerHTML =  innerHTML + '<BR>Date: ' + point.dateStart
                                        innerHTML =  innerHTML + '<BR>RA: ' + parseFloat(point.best_ra).toFixed(2).toString()
                                        innerHTML =  innerHTML + ', Dec: ' + parseFloat(point.best_dec).toFixed(2).toString()
                                        innerHTML =  innerHTML + '<BR>Error: ' + parseFloat(point.best_r95).toString() + ' deg'
                                        innerHTML =  innerHTML + '<BR>Link: <a href="' + link + '">FAVA Source Report</a>'

                                        // Define a custom tooltip offset
                                        var x_customTooltipOffset = 55
                                        var y_customTooltipOffset = 95

                                        // Show the tooltip
                                        tooltip_map.style.visibility = "visible";
                                        tooltip_map.innerHTML = innerHTML;
                                        tooltip_map.style.left = (point.xCanvas) - x_customTooltipOffset + "px";
                                        tooltip_map.style.top = (point.yCanvas) - y_customTooltipOffset + "px";

                                    }
                                }
                            }
                        }
                    }
                }
            });    

            // Add a listener that registers when a table tab is selected
            $(".navtab.catalogs").mousedown( function() { 

                changeTable($(this)); 
            })

            // Add an event lister for the 4FGL marker size checkbox
            $(".map-overlap.markersize").change(function() {
                
                // Prevent more than one checkbox to be selected at any given time
                $(".map-overlap.markersize").prop('checked', false);
                $(this).prop('checked', true);

                // Redraw the map
                Celestial.redraw()
            });

            // Add an event lister for the 4FGL variable source display checkbox
            $(".map-overlap.show_only_variable").change(function() {
                
                // Set the global variable
                show_only_variable_4FGL_sources = this.checked

                // Redraw the map
                Celestial.redraw()
            });

            // Light curve data plot selector
            $('.pagination').on('click', 'li', function() {

                // Get the current table page from the pagination element
                currentTablePage = parseInt($('.pagination li.active a')[0].text)

                var lastTablePage = parseInt($('#pagination_end a')[0].innerText)

                if ($(this).attr("id") === 'pagination_previous') {

                    // Don't do anything if already on page 1
                    if (currentTablePage === 1) {
                        $("#pagination_previous").addClass('disable');

                        console.log('already at start!')
                        return

                    } else {

                        // Catch the case when the user scrolls down from the last page
                        if (currentTablePage === parseInt($('#pagination_end a')[0].innerText)) {
                            
                            $('.pagination li.active').removeClass('active');

                            $('#1 a')[0].innerText = currentTablePage - 4
                            $('#2 a')[0].innerText = currentTablePage - 3
                            $('#3 a')[0].innerText = currentTablePage - 2
                            $('#4 a')[0].innerText = currentTablePage - 1

                            $('#4').addClass('active');

                            currentTablePage = currentTablePage - 1

                        } else {

                            // Get the new page number
                            currentTablePage = currentTablePage - 1

                            // Get the new id on which the page number should appear
                            var previous_id = parseInt($('.pagination li.active')[0].id) - 1

                            // Catch the case when the siwtching to page 1, but page 1 will occur on id 2 or 3 (e.g. when scrolling down from the end)
                            if ((previous_id !== 1) && (currentTablePage === 1)) {
                                $('#1 a')[0].innerText = currentTablePage
                                $('#2 a')[0].innerText = currentTablePage + 1
                                $('#3 a')[0].innerText = currentTablePage + 2
                                $('#4 a')[0].innerText = currentTablePage + 3    
                                return                      
                            }

                            // Remove the active class
                            $('.pagination li.active').removeClass('active');

                            // Change all of the page numbers when the user scrolls past the last id
                            if (previous_id < 1) { 
                                previous_id = 4 

                                $('#1 a')[0].innerText = currentTablePage - 3
                                $('#2 a')[0].innerText = currentTablePage - 2
                                $('#3 a')[0].innerText = currentTablePage - 1
                                $('#4 a')[0].innerText = currentTablePage 

                            } 

                            // Set the new id as active
                            $('#' + previous_id).addClass('active');

                        }

                    }

                } else if ($(this).attr("id") === 'pagination_next') {

                    // Don't do anything if already on the last page
                    if (currentTablePage === lastTablePage) {
                        return

                    } else {

                        // Get the new page number
                        currentTablePage = currentTablePage + 1

                        // Set the last page active if the user clicks next on the second to last page
                        if (currentTablePage === lastTablePage) {

                            console.log('Last page!')

                            // Remove any active states
                            $('#1').removeClass('active')
                            $('#2').removeClass('active')
                            $('#3').removeClass('active')
                            $('#4').removeClass('active')

                            // Make the last tab active
                            $('#pagination_end').addClass('active');

                        } else {


                            // Get the next id in the sequence
                            var next_id = parseInt($('.pagination li.active')[0].id) + 1

                            // Remove the active state from the currently selected id
                            $('.pagination li.active').removeClass('active');

                            // Change all of the page numbers when the user scrolls past the last id
                            if ((next_id > 4) && (maxNumberOfTableRows !== 1000)) { 
                                
                                next_id = 1 

                                console.log('currentTablePage = ' + currentTablePage)

                                if (currentTablePage+3 >= lastTablePage) {

                                    $('#1 a')[0].innerText = lastTablePage - 4
                                    $('#2 a')[0].innerText = lastTablePage - 3
                                    $('#3 a')[0].innerText = lastTablePage - 2
                                    $('#4 a')[0].innerText = lastTablePage - 1

                                    // Remove any active states
                                    $('#1').removeClass('active')
                                    $('#2').removeClass('active')
                                    $('#3').removeClass('active')

                                    // Make the last tab active
                                    $('#4').addClass('active')


                                } else {

                                    $('#1 a')[0].innerText = currentTablePage
                                    $('#2 a')[0].innerText = currentTablePage + 1
                                    $('#3 a')[0].innerText = currentTablePage + 2
                                    $('#4 a')[0].innerText = currentTablePage + 3

                                    $('#' + next_id).addClass('active');

                                }

                            } else if ((next_id > 4) && (maxNumberOfTableRows === 1000)) { 
                                
                                $('#pagination_end').addClass('active')

                            } else {

                                $('#' + next_id).addClass('active');
                            }
                        }

                    }

                } else if (($(this).attr("id") === 'pagination_dots1') || ($(this).attr("id") === 'pagination_dots2')) {
                    // ignore any clicks on the dots

                } else {

                    // Set the page number to the selected value
                    currentTablePage = parseInt($(this).text())

                    // Remove the active state from the current id and add it to selected id
                    $('.pagination li.active').removeClass('active');
                    $(this).not("#pagination_previous").not("#pagination_next").addClass('active');

                    // Change all of the page numbers when the user clicks on the end if
                    if ($(this).attr("id") === 'pagination_end') {
                        $('#1 a')[0].innerText = currentTablePage - 4
                        $('#2 a')[0].innerText = currentTablePage - 3
                        $('#3 a')[0].innerText = currentTablePage - 2
                        $('#4 a')[0].innerText = currentTablePage - 1
                    }

                }

                // Define the starting row based on the current table page and the maximum allowable number of rows
                startingTableRow = ((currentTablePage-1) * maxNumberOfTableRows)

                // Hide the spinner
                $("#loadingSpinnerImage").show();

                // Determine which table is currently being displayed
                var activeTabID = $(".nav-tabs.tables > li.active")[0].id

                // Hide the table in the selected tab
                var dataTableID = "#dataTable_" + activeTabID
                // $(dataTableID).hide();                

                console.log("startingTableRow = " + startingTableRow)
                console.log("maxNumberOfTableRows = " + maxNumberOfTableRows)

                if (activeTabID.includes('4FGL')) {
                    fillTable(data_FGL)
                } else if (activeTabID.includes('2FAV')) {
                    fillTable_2FAV(data_2FAV)
                }
            });

            // Table row count selector
            $('.dropdown-menu.row_count').on('click', 'li', function() {

                // Remove the previously active selection
                $('.dropdown-menu.row_count li.active').removeClass('active');

                // Make the selected value active
                $(this).addClass('active');

                console.log($(this).find('a')[0].innerHTML)
                // Get the label for the user selected value and update the dropdown button text
                $('.dropdown-toggle.row_count')[0].innerHTML =  $(this).find('a')[0].innerHTML + ' <span class="caret"></span>'  

                // Get the user selected maximum number of table rows
                maxNumberOfTableRows = parseInt($(this).attr('value'))

                // Determine which table is currently being displayed
                var activeTabID = $(".nav-tabs.tables > li.active")[0].id

                var data
                if (activeTabID.includes('4FGL')) {
                    data = data_FGL
                } else if (activeTabID.includes('2FAV')) {
                    data = data_2FAV
                }

                // Hide the pagination element if all rows are to be displayed
                if (maxNumberOfTableRows === -1) {
                    maxNumberOfTableRows = data.length
                    $(".pagination").hide()
                }

                // } else if (maxNumberOfTableRows === 1000) {
                //     $("#pagination_dots2").hide()

                // } else {

                //     $(".pagination").show()

                //     // Reset the pagination values
                //     $('#1 a')[0].innerText = 1
                //     $('#2 a')[0].innerText = 2
                //     $('#3 a')[0].innerText = 3
                //     $('#4 a')[0].innerText = 4

                //     // Remove the active state from the currently selected id and add it back to the first id
                //     $('.pagination li.active').removeClass('active');                    
                //     $('#1').addClass('active');

                //     // Update the pagination count
                //     $('#pagination_end a')[0].innerText = String(parseInt(data.length/maxNumberOfTableRows))

                // }


                // Hide the spinner
                $("#loadingSpinnerImage").show();

                // Show the table
                // $("#dataTable_4FGL").hide();                

                if (activeTabID.includes('4FGL')) {
                    fillTable(data_FGL)
                } else if (activeTabID.includes('2FAV')) {
                    fillTable_2FAV(data_2FAV)

                }

                resetPagination()

                // Record that a selection change has been made
                row_selector_has_changed = true;
            });

            $('#input_from').on('input', function() {

                let timeline_slider = $(".js-range-slider").data("ionRangeSlider");

                from_input = parseInt($('.form-control.input.from')[0].value)
                if ((from_input >= timeline_slider.options.min) && (from_input <= timeline_slider.options.max)) {

                    timeline_slider.update({
                        from: from_input
                    })

                    // Change the timeline background
                    $('.irs-grid-pol').css('background-color', '#a6a6a6');

                    // Rotate the timeline elements
                    $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-35px;top:20px;">0</span>')
                    $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-40px;top:-60px;">10</span>')
                    $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')
                    $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:-200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')

                    // Fill the timeline
                    if (show_2FAV === true) {
                        fillTimeline(data_2FAV, '2FAV', null);
                    }

                    if (show_2FLGC === true) {
                        fillTimeline(data_2FLGC, '2FLGC', 'GRBMET');
                    }

                    if (show_IceCube === true) {
                        fillTimeline(data_IceCube, 'IceCube', 'DISCOVERY_DATE_TJD')
                    }

                }
            });

            $('#input_to').on('input', function() {

                let timeline_slider = $(".js-range-slider").data("ionRangeSlider");

                to_input= parseInt($('.form-control.input.to')[0].value)
                if ((to_input >= timeline_slider.options.min) && (to_input <= timeline_slider.options.max)) {

                    timeline_slider.update({
                        to: to_input
                    })

                    // Change the timeline background
                    $('.irs-grid-pol').css('background-color', '#a6a6a6');

                    // Rotate the timeline elements
                    $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-35px;top:20px;">0</span>')
                    $('.irs-grid').append('<span class="irs-grid-text js-grid-text-0" style="left:-40px;top:-60px;">10</span>')
                    $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')
                    $('.irs-grid').append('<span class="irs-grid-pol" style="left:-11px;top:-200%; background-color: rgb(166, 166, 166); transform:rotate(270deg)"></span>')

                    // Fill the timeline
                    if (show_2FAV === true) {
                        fillTimeline(data_2FAV, '2FAV', null);
                    }

                    if (show_2FLGC === true) {
                        fillTimeline(data_2FLGC, '2FLGC', 'GRBMET');
                    }

                    if (show_IceCube === true) {
                        fillTimeline(data_IceCube, 'IceCube', 'DISCOVERY_DATE_TJD')
                    }

                }
            });

            $('#input_sundate').on('input', function(event) {


                let timeline_slider = $(".js-range-slider").data("ionRangeSlider");

                input_sun = parseFloat($('#input_sundate')[0].value)

                console.log(input_sun, timeline_slider.options.min, timeline_slider.options.max)

                if ((input_sun >= timeline_slider.options.min) && (input_sun <= timeline_slider.options.max)) {

                    console.log('updating sun position!')

                    // Update the Sun and Moon position
                    setSunMoonPositions()

                    // Redraw the map
                    Celestial.redraw()

                }

                event.preventDefault();
            });

            // Bind a click event to the form submission    
            $("#submitForm").on('click', function() {
                $("#magic_word_form").submit();
            });

            // Query the database only after the magic word has been submitted
            $("#magic_word_form").on("submit", function(e) {

                // Get the form data
                magicWord = document.forms["magic_word_form"]["magic_word"].value;

                e.preventDefault();

                $('#magic_word_dialog').modal('hide');

                // queryDB('TriggerList', magic_word_submitted)

                // Add the 4FGL data
                get4FGLData()

            });

            // Hide the page if the person clicks the close button
            $("#dismissForm").on('click', function(e) {
                $('#main').hide()
            });


            // Check to see if the passphrase data is stored in a cookie
            checkCookie();


        });

  </script>


    <!-- main starts here -->       
    <div id="main" style="width:2000px;">    

        <!-- Start NASA Container -->
        <div id="nasa-container" style="margin:8px 0 0 10px">

            <!-- Start NASA Banner -->
            <div id="nasa-banner-plain">

                <!-- Left - Logo -->
                <div class="nasa-logo">
                    <a href="http://www.nasa.gov/"><img src="http://fermi.gsfc.nasa.gov/ssc/inc/img/nasa_logo.gif" width="140" height="98" border="0" alt="NASA Logo"></a>
                </div>
            
                <!-- Middle - Affiliations -->
                <div id="nasa-affiliation">
                    <h1><a href="http://www.nasa.gov/">National Aeronautics and Space Administration</a></h1>
                    <h2><a href="http://www.nasa.gov/goddard">Goddard Space Flight Center</a></h2>
                </div>
                
                <!-- Right - Search and Links -->
                <div id="nasa-search-links">
                    <div id="header-links">
                        <a href="/ssc/">FSSC</a> &bull; <a href="http://heasarc.gsfc.nasa.gov/">HEASARC</a> &bull; <a href="http://science.gsfc.nasa.gov/">Sciences and Exploration</a>
                    </div>
                </div>

            </div>
            <!-- End NASA Banner -->
        <!-- End NASA Container -->
        </div>

        <!-- LCR header starts here -->
        <div>
            <div style="float: left; padding-top:12px; padding-left:25px"><img middle; style="width: 100%; height: 100%" src="./img/Fermi_Small.png"></div>
            <div style="margin-left: 25px;padding-left: 75px; padding-bottom:20px; padding-top: 5px">
                <H2>Fermi LAT Light Curve Repository (LCR)</H2>
            </div>
        </div>
        <!-- Header ends here -->

        <!-- sidebar start here -->
        <div class="col-xs-2" style="width:330px;margin-left:10px;">

            <!-- Catalog search start here -->       
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Catalog Search</h3>
                 </div>
                 <div class="panel-body">

                        <div class="row-small-gutter">
                          <div class="col-xs-4">
                            <label for="ex1">RA:</label>
                            <input id="ra_input" class="form-control" type="text" placeholder="">
                          </div>
                          <div class="col-xs-4">
                            <label for="ex2">Dec:</label>
                            <input id="dec_input" class="form-control" type="text" placeholder="">
                          </div>
                          <div class="col-xs-4">
                            <label for="ex1">Radius:</label>
                            <input id="radius_input" class="form-control" type="text" placeholder="" data-toggle="tooltip" data-placement="top" title="Tooltip on top">
                          </div>                              
                        </div>

                        <div class="row-small-gutter" style="margin-top:70px; margin-bottom:135px">
                          <div class="col-xs-12">
                                <label for="ex1">Keyword:</label>
                                <input id="keyword_input" class="form-control" id="ex1" type="text" placeholder="">
                            </div>
                        </div>

                        <div class="row-small-gutter" style="margin-top:70px;">
                            <div style="float:right; margin-top:15px; margin-right:0px">
                                <button type="submit" name="searchButton" id="search_button"  class="btn btn-primary">Search</button>
                            </div>
                        </div>

                        <div class="row-small-gutter">
                            <div style="float:right; margin-top:15px; margin-right:0px">
                                <button type="submit" name="clearButton" id="clear_button" class="btn btn-default" disabled>Clear</button>
                            </div>
                        </div>

                </div>
            </div>
            <!-- Catalog search ends here -->    

            <!-- Map options panel start here -->       
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Map Options</h3>
                </div>
                <div class="panel-body">
                        
                      <div class="row">
                        <div class="col-sm-4" style="margin-left:5px">
                          <p>Coordinate System:</p>
                        </div>
                        <div class="col-sm-6" style="margin-left:10px">
                          
                            <div class="dropdown">
                                <button style="width:130px" class="btn btn-default dropdown-toggle transform" type="button" data-toggle="dropdown">Galactic <span class="caret"></span></button>
                                <ul class="dropdown-menu transform" style="width:10px">
                                    <li id="galactic" class="active"><a href="#">Galactic</a></li>
                                    <li id="equatorial"><a href="#">Equatorial</a></li>
                                </ul>
                            </div>

                        </div>
                      </div>   

                      <div class="row" style="margin-top:0px">
                        <div class="col-sm-4" style="margin-left:5px">
                          <p>Celestial Projection:</p>
                        </div>
                        <div class="col-sm-6" style="margin-left:10px">
                          
                            <div class="dropdown">
                                <button style="width:130px" class="btn btn-default dropdown-toggle projection" type="button" data-toggle="dropdown">Aitoff <span class="caret"></span></button>
                                <ul class="dropdown-menu projection" style="width:10px">
                                    <li id="aitoff" class="active"><a href="#">Aitoff</a></li>
                                    <li id="mollweide"><a href="#">Mollweide</a></li>
                                    <li id="stereographic"><a href="#">Stereographic</a></li>
                                    <li id="equirectangular"><a href="#">Equirectangular</a></li>
                                    <li id="orthographic"><a href="#">Othographic</a></li>
                                </ul>
                            </div>

                        </div>
                      </div>                      

                      <label for="name">Coordinate Planes:</label>

                      <div class="row-small-gutter">

                        <div class="col-sm-6">
                            <label class="checkbox-inline" for="equator-label"><input class="map-overlay lines" type="checkbox" value="" id="equatorial" checked>Equatorial</label>
                        </div>
                        <div class="col-sm-5">
                            <label class="checkbox-inline" for="ecliptic-label"><input class="map-overlay lines" type="checkbox" value="" id="ecliptic" checked>Ecliptic</label>
                        </div>
                      </div>
                      <div class="row-small-gutter">
                        <div class="col-sm-6">
                            <label class="checkbox-inline" for="galactic-label"><input class="map-overlay lines" type="checkbox" value="" id="galactic" checked>Galactic</label>
                        </div>
                        <div class="col-sm-5">
                            <label class="checkbox-inline" for="supergalactic-label"><input class="map-overlay lines" type="checkbox" id="supergalactic" value="">Supergalactic</label>
                        </div>
                      </div>
                      <div style="margin-top:50px">
                        <label for="name">Overlays:</label>
                      </div>
                      <div class="row-small-gutter">
                        <div class="col-sm-6">
                            <label class="checkbox-inline"><input class="map-overlay popup" type="checkbox" id="tooltip" value="" checked>Source Info</label>
                        </div>
                        <div class="col-sm-5">
                            <label class="checkbox-inline" id="lines-ecliptic-show"><input class="map-overlay lines" type="checkbox" value="" id="graticule" checked>Grid Lines</label>
                        </div>
                      </div>
                      <div class="row-small-gutter">
                        <div class="col-sm-6">
                            <label class="checkbox-inline"><input class="map-overlay data" type="checkbox" id="constellations" value="">Constellations</label>
                        </div>
                        <div class="col-sm-5">
                            <label class="checkbox-inline"><input class="map-overlay data" type="checkbox" id="mw" value="">Milky Way</label>
                        </div>                            
                      </div>
                      <div class="row-small-gutter">
                        <div class="col-sm-6">
                            <label class="checkbox-inline"><input class="map-overlay sun" type="checkbox" id="sun" checked value="">Sun</label>
                        </div>
                        <div class="col-sm-5">
                            <label class="checkbox-inline"><input , class="map-overlay moon" type="checkbox" id="moon" value="">Moon</label>
                        </div>                            
                      </div>                  
                      <div style="margin-top:70px">
                        <label for="name">4FGL Marker Size:</label>
                      </div>
                      <div class="row-small-gutter">
                        <div class="col-sm-6">
                            <label class="checkbox-inline"><input class="map-overlap markersize" type="checkbox" id="marker_size_varindex" value="" checked>Variability Index</label>
                        </div>
                        <div class="col-sm-5">
                            <label class="checkbox-inline" id="lines-ecliptic-show"><input class="map-overlap markersize" type="checkbox" value="" id="marker_size_sig">Significance</label>
                        </div>
                      </div>
                      <div style="margin-top:30px">
                        <label for="name">4FGL Source Options:</label>
                      </div>
                      <div class="row-small-gutter">
                        <div class="col-sm-12">
                            <label class="checkbox-inline"><input class="map-overlap show_only_variable" type="checkbox" id="show_only_variable_sources" value="" checked>Hide Non-Variable Sources</label>
                        </div>
                      </div>                  

                </div>
            </div>
            <!-- Map options panel ends here -->       

            <!-- Demographics panel start here -->   
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Data Overlays</h3>
                </div>
                <!-- <div class="panel-body"> -->

                  <!-- List group -->
                <ul class="list-group">
                    <li class="list-group-item">
                            LAT Point Source Catalog (4FGL)<BR><small><a href="https://ui.adsabs.harvard.edu/abs/2020ApJS..247...33A/abstract">Abdollahi et al. 2020</a> - 5523 Sources</small>
                            <label class="switch" style="float:right; margin-top:-12px"><input id="4FGL_switch" type="checkbox" checked><span class="slider round primary"></span></label>
                    </li>                       
                    <li class="list-group-item">
                            FAVA Flare Catalog (2FAV)<BR><small><a href="https://fermi.gsfc.nasa.gov/ssc/data/access/lat/fava_catalog/">Abdollahi et al. 2017</a> - 4309 Flares</small>
                            <label class="switch" style="float:right; margin-top:-12px"><input id="2FAV_switch" type="checkbox"><span class="slider round red"></span></label>
                    </li>
                    <li class="list-group-item">
                            2nd LAT GRB Catalog (2FLGC)<BR><small><a href="https://iopscience.iop.org/article/10.3847/1538-4357/ab1d4e/pdf">Ajello 2019</a>/<a href="https://gcn.gsfc.nasa.gov/fermi_grbs.html">GCN</a> - <span id=number_of_LAT_detections>150</span> Detections</small>
                            <!-- <BR><small><a href="https://gcn.gsfc.nasa.gov/admin/fermi_lat_offline_announce.txt">GCN Notices</a><span id=number_of_offline_notices> - 0 Detections<span></small> -->
                            <label class="switch" style="float:right; margin-top:-12px"><input id='2FLGC_switch' type="checkbox"><span class="slider round green"></span></label>
                    </li>                                 
                    <li class="list-group-item">
                            IceCube Neutrino Alerts<BR><small><a href="https://gcn.gsfc.nasa.gov/amon.html">GCN/AMON Notices</a> - <span id=number_of_icecube_detections>47</span> Events</small>
                            <label class="switch" style="float:right; margin-top:-12px"><input id='IceCube_switch'  type="checkbox"><span class="slider round orange"></span></label>
                    </li>               

                </ul>

                <!-- </div> -->
            </div>

            <!-- Related resources start here -->      
            <div class="panel panel-default" style="height: 225px;">
                <div class="panel-heading">
                    <h3 class="panel-title">Related Resources</h3>
                 </div>
                    <center>
                        <table class="table table-striped">
                        <!-- <table class="table"> -->
                          <tbody>           
                                <tr><td><a href="https://fermi.gsfc.nasa.gov/ssc/">The Fermi Science Support Center</a></td></tr>
                                <tr><td><a href="https://fermi.gsfc.nasa.gov/ssc/data/access/lat/FAVA/">Fermi All-Sky Variability Analysis (FAVA)</a></td></tr>           
                                <tr><td><a href="https://fermi.gsfc.nasa.gov/ssc/data/analysis/scitools/">Fermi LAT & GBM Analysis Tutorials</a></td></tr>
                                <tr><td><a href="https://fermi.gsfc.nasa.gov/ssc/data/access/">Fermi LAT & GBM Data Access</a></td></tr>
                                <tr><td><a href="about.html">About the Light Curve Repository</a></td></tr>      
                          </tbody>
                        </table>  
                    </center>
            </div>
            <!-- Related resources ends here -->   

            <!-- Citation request start here -->    
            <div class="panel panel-default">   
                <div class="panel-heading">
                    Please reference <a href="">Kocevski et al. 2020</a> for use of any results presented in the Fermi LAT Light Curve Repository.
                </div>
            </div>
            <!--  Citation request ends here -->    

            <!-- Citation request start here -->    
<!--             <div class="panel panel-default" style="height:132px">   
                <div class="panel-heading">
                    <h3 class="panel-title">Citation Request</h3>
                </div>
                <center>
                    <div class="alert alert-default" role="alert">Please reference <a href="">Kocevski et al. 2020</a> for use of any results presented in the Fermi LAT Light Curve Repository.</div>
                </center>
            </div> -->
            <!--  Citation request ends here -->  



        </div>
        <!-- sidebar ends here -->

        <!-- Content starts here -->
        <div class="col-xs-7" style="width:1330px; margin-left:-15px">

        <!-- Catalog Map panel starts here-->  
            <div class="panel panel-default">
                <div class="panel-heading"><h3 class="panel-title">Catalog Map</h3></div>
                <div id="map_panel" class="panel-body" style="margin-top:0px; margin-bottom:0px">
                    <div id="map_container" style="overflow:hidden; border:1px">
                        <div id="celestial-map" style="width:100%; border:1px solid lightgray;padding-left:5px"></div>
                    </div>
                    <div id="celestial-form"></div>
                    <div id="cursor_coordinates" style="margin-top:-25px; margin-left:10px">RA: --, Dec: --</div> 
                    <div id="selection" width=10 height=10></div>
                    <div id="tooltip_map"></div>  
                    <!-- <img id="map_loading" src="./img/loading_apple.gif" width="30px" style="margin-top:-327px; margin-left:617px; position: absolute; float:left;"> -->
                    <span id="map_loading" style="margin-top:-340px; margin-left:585px; color:gray; position: absolute; float:left; display:none"><b>Loading data...</b></span>

                    <!-- <div id="container" class="chart"></div> -->

                    <div id="timeline" style="height:250px; border-width:1px; padding:45px 45px 15px 45px; margin-top:10px; border:solid lightgray 1px;">
                        <input type="text" class="js-range-slider" id="js-range-slider-id" name="my_range" value=""
                            data-type="double"
                            data-min="54683"
                            data-max="58945"
                            data-from="54683"
                            data-to="58945"
                            data-grid="true"
                            data-grid-num="12"
                            data-prettify-enabled="false"
                            data-grid-snap="false"
                            data-drag-interval="false"
                        />

                        <img id="timeline_spinner" src="./img/loading_apple.gif" width="30px" style="margin-top:-30px; margin-left:572px; position: relative; z-index:999; float:left; display:none">

                        <div style="margin-top:75px;">
                            <center>
                            <div id="timeline_label"><b>Modified Julian Date</b></div>
                            </center>
                        </div>

                        <div style="float:left">
                            <center>
                            <form class="form-inline" id="time_range_selector" action="javascript:void(0)">
                                <div class="form-group">
                                    <label style="margin-right:5px; font-weight: normal !important;">Sun/Moon Date: </label>
                                    <input style="width:100px" type="value" id="input_sundate" class="form-control input sun date" value="">
                                </div>

                            </form>
                            </center>
                        </div>

                        <!-- <div style="margin-top:15px;"> -->
                        <div style="float:right">
                            <center>
                            <form class="form-inline" id="time_range_selector" action="javascript:void(0)">
                                <div class="form-group">
                                    <label style="margin-right:5px; font-weight: normal !important;">From: </label>
                                    <input style="width:100px" type="value" id="input_from" class="form-control input from" value="54683">
                                </div>
                                <div class="form-group" style="margin-left:10px">
                                    <label style="margin-right:5px; font-weight: normal !important;">To:</label>
                                    <input style="width:100px" type="value" id="input_to" class="form-control input to" value="58945">
                                </div>
                                <div class="form-group" style="margin-left:10px">
                                    <div class="dropdown">
                                        <button style="margin-left:5px; width:75px" class="btn btn-default btn dropdown-toggle date-format" type="button" data-toggle="dropdown">MJD <span class="caret"></span></button>
                                        <ul class="dropdown-menu date-format" style="width:10px; margin-left:-80px;">
                                            <li id="MJD" class="active"><a href="#" onclick="return false;">MJD</a></li>
                                            <li id="MET"><a href="" onclick="return false;">MET</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <!-- <div class="form-group" style="margin-left:10px">
                                    <button type="submit" name="searchButton" id="search_button"  class="btn btn-primary">Search</button>
                                </div> -->
                            </form>
                            </center>

                        </div>
                    
                    </div>
                    <!-- <div>
                        <BR>
                        <canvas id="timeline_canvas" width="1265px" height="100" style="border:solid lightgray 1px;"></canvas>
                    </div> -->

                </div>  
            </div>
        <!-- Catalog Map panel ends here-->  

        <!-- Catalog table panel starts here-->  
        <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">Catalog Sources</h3></div>
            <div class="panel-body" id="data_table">
                <center>
                <ul class="nav nav-tabs tables" id="catalog_tabs" style="height:42px; width:100%;">
                  <li id="4FGL" target="event_display" class="navtab catalogs active"><a href="javascript:void(0)" onclick="return false;">4FGL</a></li>
                  <li id="placeholder" target="event_display" class="navtab catalogs" style="display:none"><a href="#" onclick="return false;">2FAV</a></li>
                </ul>
                <BR>
                <table class="table table-striped table-condensed table-bordered data-table" id="dataTable_4FGL" style="width:1200px; display:hidden"></table>  
                <table class="table table-striped table-condensed table-bordered data-table" id="dataTable_2FAV" style="width:1200px; display:none"></table>  
                <table class="table table-striped table-condensed table-bordered data-table" id="dataTable_2FLGC" style="width:1200px; display:none"></table>  
                <table class="table table-striped table-condensed table-bordered data-table" id="dataTable_IceCube" style="width:1200px; display:none"></table>  

                <img id="loadingSpinnerImage" src="./img/loading_apple.gif" width="30px" style="margin-top:100px; margin-bottom:100px;">
                </center>

                <!-- pagination element starts here --->
                <div class="container" style="width:1230px">
                    <div class="row">
                        <div id="table_row_selector" class="col-xs-4 text-left">
                            <div style='margin-top:-5px' class="btn-group" role="group">
                                <button class="btn btn-default dropdown-toggle row_count" type="button" value=100 data-toggle="dropdown">100 Rows <span class="caret"></span></button>
                                <ul class="dropdown-menu row_count">
                                    <li id="rows_10" value=10><a href="javascript:void(0)">10 Rows</a></li>
                                    <li id="rows_100" value=100 class="active"><a href="javascript:void(0)">100 Rows</a></li>
                                    <li id="rows_500" value=500><a href="javascript:void(0)">500 Rows</a></li>
                                    <li id="rows_1000" value=1000><a href="javascript:void(0)">1000 Rows</a></li>
                                    <li id="rows_all" value=-1><a href="javascript:void(0)">View All Sources</a></li>
                                </ul>
                            </div>
                        </div>

                        <div id="table_range_4FGL" class="col-xs-4 text-center"></div>
                        <div id="table_range_2FAV" style="display:none;" class="col-xs-4 text-center"></div>
                        <div id="table_range_2FLGC" style="display:none;" class="col-xs-4 text-center"></div>
                        <div id="table_range_IceCube" style="display:none;" class="col-xs-4 text-center"></div>

                        <div class="col-xs-4 text-right">

                            <nav style="margin-top:-25px" aria-label="Table navigation selection">
                                <ul class="pagination">

                                    <li id="pagination_previous" class="page-item">
                                      <a class="page-link" href="javascript:void(0)" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                        <span class="sr-only">Previous</span>
                                      </a>
                                    </li>

                                    <li id="pagination_start" style="display:none" class="page-item"><a class="page-link" href="javascript:void(0)">1</a></li>
                                    <li id="pagination_dots1" style="display:none" class="page-item disabled"><a class="page-link" href="javascript:void(0)">...</a></li>
                                    <li id="1" class="page-item active"><a class="page-link" href="javascript:void(0)">1</a></li>
                                    <li id="2" class="page-item"><a class="page-link" href="javascript:void(0)">2</a></li>
                                    <li id="3" class="page-item"><a class="page-link" href="javascript:void(0)">3</a></li>
                                    <li id="4" class="page-item"><a class="page-link" href="javascript:void(0)">4</a></li>
                                    <li id="pagination_dots2" class="page-item disabled"><a class="page-link" href="javascript:void(0)">...</a></li>
                                    <li id="pagination_end" class="page-item"><a class="page-link" href="javascript:void(0)"></a></li>

                                    <li id="pagination_next" class="page-item">
                                      <a class="page-link" href="javascript:void(0)" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                        <span class="sr-only">Next</span>
                                      </a>
                                    </li>

                                </ul>
                            </nav>

                        </div>
                    </div>
                </div>
                <!-- pagination element ends here --->

                <div>




                </div>


            </div> 
        </div>
        <!-- Catalog table panel ends here-->  

    

        </div>
        <!-- Content ends here -->
        <!-- </div> -->

         <!-- footer starts here --> 
        <div class="col-md-12" id="footer">
            <div id="footer-content">
                <p>
                    <hr>
                    Fermi LAT Light Curve Repository - Support Contact:<a href="mailto:daniel.kocevski@nasa.gov"> Daniel Kocevski</a>
                    <BR>
                    <BR>
                </p>
            </div>
        </div>
        <!-- footer ends here -->
    </div>
    <!-- Main ends here -->

    <!-- Magic word dialog modal view starts here -->
    <div id="magic_word_dialog" class="modal fade">
        <div class="modal-dialog" style="width:800px; margin: auto; margin-top:10%">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" style="text-align: center;">Welcome to the Fermi LAT Light Curve Repository</h4>
                </div>

                <div class="modal-body center-block" style="text-align: center; height:200px; margin-top:10%">

                    
                    This page is currently under developement.<BR>Please enter the passphrase to view the draft page:
                    
                    <BR>
                    <BR>
                
                    <form id="magic_word_form" name='MagicWordForm'>
                        <input id="magic_word" type="text" class="input-small" placeholder="">
                        </form>

                </div> <!-- /.modal-body -->

                <div class="modal-footer">             
                    <div id="SaveButtonDiv" style="float: right;">
                        <button type="button" id="submitForm" class="btn btn-primary" style="color:white;font-size: 12px;margin:10px">Submit</button>
                    </div>  
                    <div style="float: right;"> 
                        <button type="button" id="dismissForm" class="btn btn-default" data-dismiss="modal" style="font-size: 12px;margin-top:10px">Close</button>
                    </div> 
                </div> <!-- /.modal-footer -->

            </div> <!-- /.modal-content -->
        </div> <!-- /.modal-dialog -->
    </div> <!-- /.modal -->  



</body>
</html>
